<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>HeatXAI ‚Äî Conception d'√âchangeurs de Chaleur</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üî•</text></svg>">
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600;700&family=Space+Mono:wght@400;700&family=Playfair+Display:wght@700;900&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<style>
:root{--bg:#0a0e1a;--bg2:#111827;--card:#1a2035;--inp:#0d1220;--acc:#f59e0b;--accL:#fbbf24;--accD:#d97706;--t1:#f1f5f9;--t2:#94a3b8;--t3:#64748b;--brd:#1e293b;--ok:#10b981;--warn:#f59e0b;--err:#ef4444;--info:#3b82f6}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--t1);min-height:100vh}
body::before{content:'';position:fixed;inset:0;background:radial-gradient(ellipse at 20% 0%,rgba(245,158,11,.08)0%,transparent 50%),radial-gradient(ellipse at 80% 100%,rgba(59,130,246,.05)0%,transparent 50%);pointer-events:none;z-index:0}
.header{position:sticky;top:0;z-index:100;background:rgba(10,14,26,.92);backdrop-filter:blur(20px);border-bottom:1px solid var(--brd);padding:.8rem 2rem;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:.5rem}
.logo{display:flex;align-items:center;gap:.6rem}
.logo-icon{width:38px;height:38px;background:linear-gradient(135deg,var(--acc),var(--accD));border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:1.1rem}
.logo-text{font-family:'Playfair Display',serif;font-size:1.4rem;font-weight:900;background:linear-gradient(135deg,var(--accL),var(--acc));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.logo-sub{font-size:.65rem;color:var(--t3);letter-spacing:2px;text-transform:uppercase}
.nav-tabs{display:flex;gap:2px;background:var(--bg2);border-radius:12px;padding:3px;overflow-x:auto}
.nav-tab{padding:.55rem 1rem;border:none;background:none;color:var(--t2);cursor:pointer;border-radius:10px;font-family:'DM Sans',sans-serif;font-size:.82rem;font-weight:500;transition:all .3s;white-space:nowrap}
.nav-tab:hover{color:var(--t1)}.nav-tab.active{background:var(--acc);color:var(--bg);font-weight:600}
.main{position:relative;z-index:1;max-width:1600px;margin:0 auto;padding:1.5rem 2rem}
.panel{display:none;animation:fadeIn .35s ease}.panel.active{display:block}
@keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
.card{background:var(--card);border:1px solid var(--brd);border-radius:14px;padding:1.4rem;margin-bottom:1.4rem;box-shadow:0 4px 20px rgba(0,0,0,.25)}
.card-title{font-family:'Playfair Display',serif;font-size:1.15rem;font-weight:700;margin-bottom:1rem;display:flex;align-items:center;gap:.5rem}
.fg{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:1rem}
.fg label{font-size:.78rem;color:var(--t2);font-weight:500;text-transform:uppercase;letter-spacing:.4px}
.fg input,.fg select,.fg textarea{padding:.65rem .9rem;background:var(--inp);border:1px solid var(--brd);border-radius:9px;color:var(--t1);font-family:'Space Mono',monospace;font-size:.88rem;transition:border-color .3s;width:100%}
.fg input:focus,.fg select:focus,.fg textarea:focus{outline:none;border-color:var(--acc);box-shadow:0 0 0 3px rgba(245,158,11,.15)}
.fg select option{background:var(--bg2);color:var(--t1)}
.fg .unit{font-size:.72rem;color:var(--t3);font-family:'Space Mono',monospace}
.fg>div{display:flex;flex-direction:column;gap:.3rem}
.btn{padding:.75rem 1.8rem;border:none;border-radius:11px;font-family:'DM Sans',sans-serif;font-weight:600;font-size:.92rem;cursor:pointer;transition:all .3s;display:inline-flex;align-items:center;gap:.4rem}
.btn-p{background:linear-gradient(135deg,var(--acc),var(--accD));color:var(--bg)}
.btn-p:hover{transform:translateY(-2px);box-shadow:0 8px 24px rgba(245,158,11,.3)}
.btn-s{background:var(--bg2);color:var(--t1);border:1px solid var(--brd)}
.btn-s:hover{border-color:var(--acc)}
.btn-group{display:flex;gap:.7rem;margin-top:1.4rem;flex-wrap:wrap}
.rg{display:grid;grid-template-columns:repeat(auto-fit,minmax(170px,1fr));gap:.8rem}
.ri{background:var(--inp);border:1px solid var(--brd);border-radius:11px;padding:1rem;text-align:center}
.rv{font-family:'Space Mono',monospace;font-size:1.5rem;font-weight:700;color:var(--acc);line-height:1.2}
.rl{font-size:.72rem;color:var(--t2);margin-top:.25rem;text-transform:uppercase;letter-spacing:.4px}
.ru{font-size:.8rem;color:var(--t3);font-family:'Space Mono',monospace}
.two{display:grid;grid-template-columns:1fr 1fr;gap:1.4rem}
@media(max-width:900px){.two{grid-template-columns:1fr}.header{flex-direction:column}.nav-tabs{flex-wrap:wrap}}
.chart-c{position:relative;height:340px;margin:.8rem 0}
.wb{background:rgba(245,158,11,.1);border:1px solid var(--acc);border-radius:10px;padding:1rem;font-size:.85rem;color:var(--accL);margin:1rem 0}
.ib{background:rgba(59,130,246,.1);border:1px solid var(--info);border-radius:10px;padding:1rem;font-size:.85rem;color:#93c5fd;margin:1rem 0}
.eb{background:rgba(239,68,68,.1);border:1px solid var(--err);border-radius:10px;padding:1rem;font-size:.85rem;color:#fca5a5;margin:1rem 0}
.okb{background:rgba(16,185,129,.1);border:1px solid var(--ok);border-radius:10px;padding:1rem;font-size:.85rem;color:#6ee7b7;margin:1rem 0}
.rt{width:100%;border-collapse:collapse;margin:.8rem 0;font-size:.88rem}
.rt th,.rt td{padding:.55rem .9rem;text-align:left;border-bottom:1px solid var(--brd)}
.rt th{color:var(--acc);font-weight:600;text-transform:uppercase;font-size:.73rem;letter-spacing:.4px}
.rs{border-left:3px solid var(--acc);padding-left:1.4rem;margin-bottom:1.4rem}
.rs h3{font-family:'Playfair Display',serif;margin-bottom:.4rem}
.rs p,.rs li{color:var(--t2);line-height:1.65;font-size:.9rem}
.tag{display:inline-block;padding:.15rem .5rem;border-radius:5px;font-size:.7rem;font-weight:600;margin-left:.4rem}
.tag-st{background:rgba(59,130,246,.2);color:#93c5fd}
.tag-phe{background:rgba(16,185,129,.2);color:#6ee7b7}
.tag-dp{background:rgba(168,85,247,.2);color:#c4b5fd}
.tag-ac{background:rgba(245,158,11,.2);color:#fbbf24}
.tag-sp{background:rgba(239,68,68,.2);color:#fca5a5}
.loading{display:none;position:fixed;inset:0;background:rgba(10,14,26,.88);z-index:1000;justify-content:center;align-items:center;flex-direction:column;gap:1.2rem}
.loading.show{display:flex}
.spinner{width:55px;height:55px;border:3px solid var(--brd);border-top-color:var(--acc);border-radius:50%;animation:spin 1s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.lt{font-size:1rem;color:var(--acc);text-align:center}
.phase-fields{display:none}.phase-fields.show{display:grid}
.side-label{font-family:'Playfair Display',serif;font-size:1rem;color:var(--acc);border-bottom:1px solid var(--brd);padding-bottom:.5rem;margin-bottom:.8rem;display:flex;align-items:center;gap:.5rem}
::-webkit-scrollbar{width:5px}::-webkit-scrollbar-track{background:var(--bg)}::-webkit-scrollbar-thumb{background:var(--brd);border-radius:3px}
.supplier-card{background:var(--inp);border:1px solid var(--brd);border-radius:11px;padding:1.2rem;transition:border-color .3s}
.supplier-card:hover{border-color:var(--acc)}
.supplier-card h4{color:var(--acc);margin-bottom:.3rem}
.supplier-card .country{font-size:.78rem;color:var(--t3)}
.supplier-card .spec{font-size:.85rem;color:var(--t2);margin:.4rem 0}
.supplier-card a{color:var(--accL);text-decoration:none;font-size:.82rem}
.supplier-card a:hover{text-decoration:underline}
.supplier-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:1rem}
.spec-sheet{background:#fff;color:#111;border-radius:11px;padding:2rem;font-family:'DM Sans',sans-serif;font-size:.85rem}
.spec-sheet h2{text-align:center;margin-bottom:1rem;font-size:1.2rem}
.spec-sheet table{width:100%;border-collapse:collapse;margin:.8rem 0}
.spec-sheet th,.spec-sheet td{border:1px solid #ccc;padding:.4rem .6rem;font-size:.8rem}
.spec-sheet th{background:#f0f0f0;font-weight:600}
.spec-sheet .section-title{background:var(--acc);color:#fff;font-weight:700;text-align:center}
.spec-sheet input{border:none;border-bottom:1px dashed #999;width:100%;font-family:'DM Sans',sans-serif;font-size:.8rem;padding:.2rem;background:transparent}
.spec-sheet input:focus{outline:none;border-bottom-color:var(--acc)}
@media print{
  .header,.nav-tabs,.btn-group,.no-print{display:none!important}
  .panel{display:block!important}
  .panel:not(.print-target){display:none!important}
  .spec-sheet{box-shadow:none;border-radius:0}
  body{background:#fff;color:#111}
}
</style>
</head>
<body>
<div class="loading" id="ld"><div class="spinner"></div><div class="lt" id="ldT">Calculs en cours...</div></div>

<header class="header">
<div class="logo">
  <div class="logo-icon">üî•</div>
  <div><div class="logo-text">HeatXAI</div><div class="logo-sub">Conception d'√©changeurs de chaleur</div></div>
</div>
<nav class="nav-tabs">
  <button class="nav-tab active" onclick="sp('saisie')">Saisie</button>
  <button class="nav-tab" onclick="sp('resultats')">R√©sultats</button>
  <button class="nav-tab" onclick="sp('geometrie')">G√©om√©trie</button>
  <button class="nav-tab" onclick="sp('courbes')">Courbes</button>
  <button class="nav-tab" onclick="sp('fournisseurs')">Fournisseurs</button>
  <button class="nav-tab" onclick="sp('datasheet')">Fiche Spec</button>
  <button class="nav-tab" onclick="sp('rapport')">Rapport</button>
</nav>
</header>

<main class="main">

<!-- ==================== ONGLET 1 : SAISIE ==================== -->
<div class="panel active" id="p-saisie">
<div class="two">

<!-- C√îT√â CHAUD -->
<div class="card">
  <div class="card-title">üî¥ C√¥t√© Chaud (Hot Side)</div>
  <div class="fg">
    <div><label>Fluide</label><select id="hFluid" onchange="onFluidChange('h')">
      <option value="">‚Äî S√©lectionner ‚Äî</option>
      <option value="custom">‚úèÔ∏è Saisie manuelle</option>
    </select></div>
    <div><label>D√©bit massique</label><input type="number" id="hFlow" step="any" placeholder="0"><span class="unit">kg/h</span></div>
    <div><label>Temp√©rature entr√©e</label><input type="number" id="hTin" step="any" placeholder="0"><span class="unit">¬∞C</span></div>
    <div><label>Temp√©rature sortie</label><input type="number" id="hTout" step="any" placeholder="0"><span class="unit">¬∞C</span></div>
    <div><label>Pression service</label><input type="number" id="hP" step="any" value="3"><span class="unit">bar abs</span></div>
    <div><label>√âtat</label><select id="hState" onchange="onStateChange('h')">
      <option value="liquid">Liquide</option>
      <option value="gas">Gaz</option>
      <option value="condensation">Condensation</option>
      <option value="evaporation">√âvaporation</option>
    </select></div>
  </div>
  <div class="phase-fields fg" id="hPhase" style="margin-top:1rem">
    <div><label>Titre vapeur entr√©e</label><input type="number" id="hXin" step="0.01" value="1" min="0" max="1"><span class="unit">0-1</span></div>
    <div><label>Titre vapeur sortie</label><input type="number" id="hXout" step="0.01" value="0" min="0" max="1"><span class="unit">0-1</span></div>
    <div><label>Chaleur latente</label><input type="number" id="hLat" step="any" placeholder="auto"><span class="unit">kJ/kg</span></div>
  </div>
  <!-- Propri√©t√©s manuelles -->
  <div class="fg" id="hManual" style="display:none;margin-top:1rem">
    <div><label>Masse volumique œÅ</label><input type="number" id="hRho" step="any"><span class="unit">kg/m¬≥</span></div>
    <div><label>Viscosit√© Œº</label><input type="number" id="hMu" step="any"><span class="unit">mPa¬∑s</span></div>
    <div><label>Cp</label><input type="number" id="hCp" step="any"><span class="unit">kJ/(kg¬∑K)</span></div>
    <div><label>Conductivit√© Œª</label><input type="number" id="hLambda" step="any"><span class="unit">W/(m¬∑K)</span></div>
  </div>
</div>

<!-- C√îT√â FROID -->
<div class="card">
  <div class="card-title">üîµ C√¥t√© Froid (Cold Side)</div>
  <div class="fg">
    <div><label>Fluide</label><select id="cFluid" onchange="onFluidChange('c')">
      <option value="">‚Äî S√©lectionner ‚Äî</option>
      <option value="custom">‚úèÔ∏è Saisie manuelle</option>
    </select></div>
    <div><label>D√©bit massique</label><input type="number" id="cFlow" step="any" placeholder="0"><span class="unit">kg/h</span></div>
    <div><label>Temp√©rature entr√©e</label><input type="number" id="cTin" step="any" placeholder="0"><span class="unit">¬∞C</span></div>
    <div><label>Temp√©rature sortie</label><input type="number" id="cTout" step="any" placeholder="0"><span class="unit">¬∞C</span></div>
    <div><label>Pression service</label><input type="number" id="cP" step="any" value="3"><span class="unit">bar abs</span></div>
    <div><label>√âtat</label><select id="cState" onchange="onStateChange('c')">
      <option value="liquid">Liquide</option>
      <option value="gas">Gaz</option>
      <option value="condensation">Condensation</option>
      <option value="evaporation">√âvaporation</option>
    </select></div>
  </div>
  <div class="phase-fields fg" id="cPhase" style="margin-top:1rem">
    <div><label>Titre vapeur entr√©e</label><input type="number" id="cXin" step="0.01" value="0" min="0" max="1"><span class="unit">0-1</span></div>
    <div><label>Titre vapeur sortie</label><input type="number" id="cXout" step="0.01" value="1" min="0" max="1"><span class="unit">0-1</span></div>
    <div><label>Chaleur latente</label><input type="number" id="cLat" step="any" placeholder="auto"><span class="unit">kJ/kg</span></div>
  </div>
  <div class="fg" id="cManual" style="display:none;margin-top:1rem">
    <div><label>Masse volumique œÅ</label><input type="number" id="cRho" step="any"><span class="unit">kg/m¬≥</span></div>
    <div><label>Viscosit√© Œº</label><input type="number" id="cMu" step="any"><span class="unit">mPa¬∑s</span></div>
    <div><label>Cp</label><input type="number" id="cCp" step="any"><span class="unit">kJ/(kg¬∑K)</span></div>
    <div><label>Conductivit√© Œª</label><input type="number" id="cLambda" step="any"><span class="unit">W/(m¬∑K)</span></div>
  </div>
</div>
</div>

<!-- PARAM√àTRES DE CONCEPTION -->
<div class="card">
  <div class="card-title">‚öôÔ∏è Param√®tres de conception</div>
  <div class="fg">
    <div><label>ŒîP max c√¥t√© chaud</label><input type="number" id="dPh" step="any" value="50"><span class="unit">kPa</span></div>
    <div><label>ŒîP max c√¥t√© froid</label><input type="number" id="dPc" step="any" value="50"><span class="unit">kPa</span></div>
    <div><label>Fouling c√¥t√© chaud</label><input type="number" id="foulH" step="0.00001" value="0.00018"><span class="unit">m¬≤¬∑K/W</span></div>
    <div><label>Fouling c√¥t√© froid</label><input type="number" id="foulC" step="0.00001" value="0.00018"><span class="unit">m¬≤¬∑K/W</span></div>
    <div><label>Surdesign</label><input type="number" id="overdesign" step="1" value="15"><span class="unit">%</span></div>
    <div><label>Mat√©riau tubes</label><select id="matTube">
      <option value="cs">Acier carbone</option>
      <option value="ss304">Inox 304</option>
      <option value="ss316" selected>Inox 316L</option>
      <option value="ti">Titane</option>
      <option value="cu">Cuivre</option>
      <option value="cuni">Cupro-nickel 90/10</option>
      <option value="hast">Hastelloy C-276</option>
    </select></div>
    <div><label>Mat√©riau calandre</label><select id="matShell">
      <option value="cs" selected>Acier carbone</option>
      <option value="ss304">Inox 304</option>
      <option value="ss316">Inox 316L</option>
      <option value="ti">Titane</option>
      <option value="hast">Hastelloy C-276</option>
    </select></div>
    <div><label>Configuration</label><select id="flowConfig">
      <option value="counter">Contre-courant</option>
      <option value="parallel">Co-courant</option>
      <option value="crossflow">Courants crois√©s</option>
      <option value="shell12">Calandre 1-2</option>
      <option value="shell24">Calandre 2-4</option>
    </select></div>
  </div>
</div>

<div class="btn-group">
  <button class="btn btn-p" onclick="calculate()">‚ö° Calculer le dimensionnement</button>
  <button class="btn btn-s" onclick="resetForm()">üîÑ R√©initialiser</button>
  <button class="btn btn-s" onclick="loadExample()">üìã Exemple eau/eau</button>
</div>
</div>

<!-- ==================== ONGLET 2 : R√âSULTATS ==================== -->
<div class="panel" id="p-resultats">
<div id="noResults" class="ib">Lancez un calcul depuis l'onglet Saisie pour voir les r√©sultats.</div>
<div id="resultsContent" style="display:none">

<div class="card">
  <div class="card-title">‚ö° Bilan Thermique</div>
  <div class="rg" id="rgThermal"></div>
</div>

<div class="card">
  <div class="card-title">üè∑Ô∏è Type d'√©changeur recommand√©</div>
  <div id="hxTypeRecommendation"></div>
</div>

<div class="card">
  <div class="card-title">üìê Dimensionnement pr√©liminaire</div>
  <div class="rg" id="rgSizing"></div>
</div>

<div class="card">
  <div class="card-title">üíß V√©rification hydraulique</div>
  <div class="rg" id="rgHydraulic"></div>
  <div id="hydraulicAlerts"></div>
</div>

<div class="card">
  <div class="card-title">üî¨ Coefficients de transfert</div>
  <div class="rg" id="rgCoeff"></div>
</div>

</div>
</div>

<!-- ==================== ONGLET 3 : G√âOM√âTRIE ==================== -->
<div class="panel" id="p-geometrie">
<div id="noGeom" class="ib">Lancez un calcul pour voir la g√©om√©trie d√©taill√©e.</div>
<div id="geomContent" style="display:none">
<div class="two">
  <div class="card">
    <div class="card-title">üîß Param√®tres g√©om√©triques</div>
    <div id="geomParams"></div>
  </div>
  <div class="card">
    <div class="card-title">üìä Sch√©ma de l'√©changeur</div>
    <div id="geomSVG"></div>
  </div>
</div>
<div class="card">
  <div class="card-title">üìã Types TEMA ‚Äî R√©f√©rence</div>
  <div id="temaRef"></div>
</div>
</div>
</div>

<!-- ==================== ONGLET 4 : COURBES ==================== -->
<div class="panel" id="p-courbes">
<div id="noCurves" class="ib">Lancez un calcul pour voir les courbes de performance.</div>
<div id="curvesContent" style="display:none">
<div class="two">
  <div class="card"><div class="card-title">üå°Ô∏è Profil de temp√©rature</div><div class="chart-c"><canvas id="chartTemp"></canvas></div></div>
  <div class="card"><div class="card-title">üìà Efficacit√© Œµ vs NTU</div><div class="chart-c"><canvas id="chartNTU"></canvas></div></div>
</div>
<div class="two">
  <div class="card"><div class="card-title">üíß ŒîP vs D√©bit</div><div class="chart-c"><canvas id="chartDP"></canvas></div></div>
  <div class="card"><div class="card-title">üîÑ U vs D√©bit</div><div class="chart-c"><canvas id="chartU"></canvas></div></div>
</div>
<div class="card"><div class="card-title">üìä Diagramme Q-T (Courbes composites)</div><div class="chart-c"><canvas id="chartQT"></canvas></div></div>
</div>
</div>

<!-- ==================== ONGLET 5 : FOURNISSEURS ==================== -->
<div class="panel" id="p-fournisseurs">
<div class="card">
  <div class="card-title">üè≠ Fournisseurs d'√©changeurs de chaleur</div>
  <div class="ib" id="supplierFilter">Filtrage automatique selon le type d'√©changeur recommand√©. Lancez d'abord un calcul.</div>
  <div class="supplier-grid" id="supplierGrid"></div>
</div>
</div>

<!-- ==================== ONGLET 6 : FICHE SPEC ==================== -->
<div class="panel" id="p-datasheet">
<div id="noSpec" class="ib">Lancez un calcul pour g√©n√©rer la fiche de sp√©cification.</div>
<div id="specContent" style="display:none">
  <div class="btn-group no-print" style="margin-bottom:1rem">
    <button class="btn btn-p" onclick="printSpec()">üñ®Ô∏è Imprimer / Export PDF</button>
  </div>
  <div id="specSheet"></div>
</div>
</div>

<!-- ==================== ONGLET 7 : RAPPORT ==================== -->
<div class="panel" id="p-rapport">
<div id="noReport" class="ib">Lancez un calcul pour g√©n√©rer le rapport technique.</div>
<div id="reportContent" style="display:none">
  <div class="btn-group no-print" style="margin-bottom:1rem">
    <button class="btn btn-p" onclick="printReport()">üñ®Ô∏è Imprimer le rapport</button>
  </div>
  <div id="reportSheet"></div>
</div>
</div>

</main>

<script>
/* ====================================================================
   HeatXAI ‚Äî Moteur de calcul d'√©changeurs de chaleur
   ==================================================================== */

// ===================== BASE DE DONN√âES FLUIDES =====================
const FLUIDS = {
  "water":       {name:"Eau",               rho:995, mu:0.8, cp:4.18, lam:0.62, pr:5.4, lat:2257, tsat:100, cat:"liquid"},
  "steam_lp":    {name:"Vapeur BP (3 bar)", rho:1.65, mu:0.012, cp:2.08, lam:0.027, pr:0.96, lat:2164, tsat:133.5, cat:"gas"},
  "steam_mp":    {name:"Vapeur MP (10 bar)",rho:5.15, mu:0.014, cp:2.21, lam:0.033, pr:0.95, lat:2015, tsat:179.9, cat:"gas"},
  "steam_hp":    {name:"Vapeur HP (40 bar)",rho:20.1, mu:0.017, cp:2.68, lam:0.047, pr:0.97, lat:1714, tsat:250.4, cat:"gas"},
  "air":         {name:"Air",               rho:1.18, mu:0.0185, cp:1.006, lam:0.026, pr:0.71, lat:0, cat:"gas"},
  "nitrogen":    {name:"Azote",             rho:1.15, mu:0.0178, cp:1.04, lam:0.026, pr:0.71, lat:199, tsat:-196, cat:"gas"},
  "therminol55": {name:"Therminol 55",      rho:868, mu:3.5, cp:1.88, lam:0.12, pr:55, lat:0, cat:"liquid"},
  "therminol66": {name:"Therminol 66",      rho:998, mu:6.0, cp:1.56, lam:0.118, pr:80, lat:0, cat:"liquid"},
  "dowtherm_a":  {name:"Dowtherm A",        rho:1056, mu:3.7, cp:1.55, lam:0.14, pr:41, lat:0, cat:"liquid"},
  "glycol30":    {name:"Glycol EG 30%",     rho:1038, mu:2.5, cp:3.56, lam:0.46, pr:19.4, lat:0, cat:"liquid"},
  "glycol50":    {name:"Glycol EG 50%",     rho:1070, mu:4.0, cp:3.14, lam:0.38, pr:33, lat:0, cat:"liquid"},
  "methanol":    {name:"M√©thanol",          rho:791, mu:0.55, cp:2.53, lam:0.20, pr:6.9, lat:1100, tsat:64.7, cat:"liquid"},
  "ethanol":     {name:"√âthanol",           rho:789, mu:1.07, cp:2.44, lam:0.17, pr:15.4, lat:846, tsat:78.4, cat:"liquid"},
  "acetone":     {name:"Ac√©tone",           rho:784, mu:0.31, cp:2.16, lam:0.16, pr:4.2, lat:539, tsat:56.2, cat:"liquid"},
  "toluene":     {name:"Tolu√®ne",           rho:867, mu:0.56, cp:1.70, lam:0.13, pr:7.3, lat:351, tsat:110.6, cat:"liquid"},
  "hexane":      {name:"Hexane",            rho:655, mu:0.30, cp:2.27, lam:0.12, pr:5.7, lat:335, tsat:68.7, cat:"liquid"},
  "heptane":     {name:"Heptane",           rho:684, mu:0.39, cp:2.25, lam:0.12, pr:7.3, lat:318, tsat:98.4, cat:"liquid"},
  "ammonia":     {name:"Ammoniac",          rho:602, mu:0.13, cp:4.74, lam:0.49, pr:1.3, lat:1370, tsat:-33.3, cat:"liquid"},
  "r134a":       {name:"R-134a",            rho:1206, mu:0.20, cp:1.43, lam:0.082, pr:3.5, lat:217, tsat:-26.1, cat:"liquid"},
  "r410a":       {name:"R-410A",            rho:1062, mu:0.15, cp:1.84, lam:0.088, pr:3.1, lat:221, tsat:-51.4, cat:"liquid"},
  "co2":         {name:"CO‚ÇÇ (liquide)",     rho:770, mu:0.07, cp:2.16, lam:0.085, pr:1.8, lat:231, tsat:-78.5, cat:"liquid"},
  "propane":     {name:"Propane",           rho:493, mu:0.10, cp:2.52, lam:0.096, pr:2.6, lat:426, tsat:-42.1, cat:"liquid"},
  "butane":      {name:"Butane",            rho:573, mu:0.16, cp:2.43, lam:0.11, pr:3.5, lat:386, tsat:-0.5, cat:"liquid"},
  "fuel_light":  {name:"Fuel l√©ger",        rho:850, mu:3.0, cp:2.05, lam:0.13, pr:47, lat:0, cat:"liquid"},
  "fuel_heavy":  {name:"Fuel lourd",        rho:950, mu:50, cp:1.88, lam:0.12, pr:785, lat:0, cat:"liquid"},
  "crude_oil":   {name:"P√©trole brut",      rho:870, mu:8.0, cp:2.05, lam:0.13, pr:126, lat:0, cat:"liquid"},
  "kerosene":    {name:"K√©ros√®ne",          rho:810, mu:1.6, cp:2.01, lam:0.145, pr:22, lat:0, cat:"liquid"},
  "naphtha":     {name:"Naphta",            rho:730, mu:0.5, cp:2.14, lam:0.13, pr:8.2, lat:0, cat:"liquid"},
  "h2so4_98":    {name:"H‚ÇÇSO‚ÇÑ 98%",        rho:1830, mu:25, cp:1.38, lam:0.36, pr:96, lat:0, cat:"liquid"},
  "h2so4_70":    {name:"H‚ÇÇSO‚ÇÑ 70%",        rho:1615, mu:8.0, cp:1.63, lam:0.43, pr:30, lat:0, cat:"liquid"},
  "naoh_50":     {name:"NaOH 50%",          rho:1525, mu:12, cp:2.56, lam:0.55, pr:56, lat:0, cat:"liquid"},
  "naoh_30":     {name:"NaOH 30%",          rho:1330, mu:4.5, cp:3.01, lam:0.58, pr:23, lat:0, cat:"liquid"},
  "hcl_30":      {name:"HCl 30%",           rho:1149, mu:1.7, cp:2.73, lam:0.45, pr:10.3, lat:0, cat:"liquid"},
  "brine":       {name:"Saumure NaCl 20%",  rho:1148, mu:1.6, cp:3.33, lam:0.54, pr:9.9, lat:0, cat:"liquid"},
  "seawater":    {name:"Eau de mer",        rho:1025, mu:1.08, cp:3.99, lam:0.6, pr:7.2, lat:0, cat:"liquid"},
  "mineral_oil": {name:"Huile min√©rale",    rho:870, mu:20, cp:1.88, lam:0.13, pr:290, lat:0, cat:"liquid"},
  "olive_oil":   {name:"Huile v√©g√©tale",    rho:910, mu:65, cp:1.97, lam:0.17, pr:753, lat:0, cat:"liquid"},
  "milk":        {name:"Lait",              rho:1030, mu:2.0, cp:3.93, lam:0.55, pr:14.3, lat:0, cat:"liquid"},
  "juice":       {name:"Jus de fruit",      rho:1050, mu:1.5, cp:3.85, lam:0.55, pr:10.5, lat:0, cat:"liquid"},
  "beer":        {name:"Bi√®re",             rho:1010, mu:1.4, cp:4.05, lam:0.58, pr:9.8, lat:0, cat:"liquid"},
};

// ===================== CONDUCTIVIT√â DES MAT√âRIAUX =====================
const MAT_COND = {cs:50, ss304:16.3, ss316:16.3, ti:21.9, cu:386, cuni:29, hast:11.1};
const MAT_NAMES = {cs:"Acier carbone",ss304:"Inox 304",ss316:"Inox 316L",ti:"Titane",cu:"Cuivre",cuni:"Cupro-nickel 90/10",hast:"Hastelloy C-276"};

// ===================== COEFFICIENTS U TYPIQUES =====================
const U_TABLE = {
  "liquid-liquid":   {low:300, mid:800, high:1500, typical:800},
  "liquid-gas":      {low:15, mid:60, high:150, typical:60},
  "gas-gas":         {low:5, mid:25, high:50, typical:25},
  "steam-liquid":    {low:500, mid:2000, high:4000, typical:2000},
  "steam-gas":       {low:15, mid:60, high:200, typical:60},
  "condensation-liquid":{low:500, mid:1500, high:4000, typical:1500},
  "condensation-gas":{low:15, mid:50, high:150, typical:50},
  "liquid-evaporation":{low:300, mid:1000, high:3000, typical:1000},
  "steam-evaporation":{low:500, mid:1500, high:3000, typical:1500},
};

// ===================== FOULING FACTORS TEMA =====================
const FOULING_DEFAULTS = {
  "water":0.00018,"steam_lp":0.00009,"steam_mp":0.00009,"steam_hp":0.00009,
  "air":0.00035,"nitrogen":0.00018,"therminol55":0.00018,"therminol66":0.00018,
  "dowtherm_a":0.00018,"glycol30":0.00035,"glycol50":0.00035,
  "methanol":0.00018,"ethanol":0.00018,"acetone":0.00009,"toluene":0.00018,
  "fuel_light":0.00035,"fuel_heavy":0.00088,"crude_oil":0.00053,
  "h2so4_98":0.00035,"naoh_50":0.00035,"seawater":0.00035,
  "mineral_oil":0.00053,"olive_oil":0.00053,"milk":0.00035,
};

// ===================== FOURNISSEURS =====================
const SUPPLIERS = [
  {name:"Alfa Laval",country:"Su√®de",types:["phe","spiral","st","welded"],spec:"Leader mondial plaques & spirales",url:"https://www.alfalaval.com",logo:"üá∏üá™"},
  {name:"Kelvion",country:"Allemagne",types:["phe","st","ac","finned"],spec:"Tous types, expertise industrielle",url:"https://www.kelvion.com",logo:"üá©üá™"},
  {name:"SWEP",country:"Su√®de",types:["bphe"],spec:"Plaques bras√©es (HVAC-R, process)",url:"https://www.swep.net",logo:"üá∏üá™"},
  {name:"Tranter",country:"USA",types:["phe","shellplate"],spec:"Plaques joint√©es, shell & plate",url:"https://www.tranter.com",logo:"üá∫üá∏"},
  {name:"API Heat Transfer",country:"USA",types:["st","phe","ac"],spec:"Tous types depuis 1879",url:"https://www.apiheattransfer.com",logo:"üá∫üá∏"},
  {name:"Funke",country:"Allemagne",types:["phe","st"],spec:"Plaques et tubes (groupe HYDAC)",url:"https://www.funke.de",logo:"üá©üá™"},
  {name:"Danfoss (Sondex)",country:"Danemark",types:["phe","bphe"],spec:"Plaques traditionnelles et bras√©es",url:"https://heatexchangers.danfoss.com",logo:"üá©üá∞"},
  {name:"HRS Heat Exchangers",country:"UK",types:["st","scraped","corrugated"],spec:"Tubes, racl√©s, fluides visqueux",url:"https://www.hrs-heatexchangers.com",logo:"üá¨üáß"},
  {name:"Barriquand",country:"France",types:["welded","phe","st","bphe"],spec:"Platular¬Æ (plaques soud√©es), tous types",url:"https://www.barriquand.com",logo:"üá´üá∑"},
  {name:"Onda",country:"Italie",types:["bphe","st","ac"],spec:"Plaques bras√©es, a√©ror√©frig√©rants",url:"https://www.onda-it.com",logo:"üáÆüáπ"},
  {name:"Mersen",country:"France",types:["graphite","corrosion"],spec:"Graphite, milieux tr√®s corrosifs",url:"https://www.mersen.com",logo:"üá´üá∑"},
  {name:"Labbe Process Equipment",country:"France",types:["st","custom"],spec:"Inox sur mesure, √©quipements proc√©d√©s",url:"https://www.labbe.fr",logo:"üá´üá∑"},
  {name:"Vahterus",country:"Finlande",types:["pshe"],spec:"Plate & shell (haute pression/temp)",url:"https://www.vahterus.com",logo:"üá´üáÆ"},
  {name:"Hisaka Works",country:"Japon",types:["phe","bphe"],spec:"Plaques, innovation japonaise",url:"https://www.hisaka.co.jp/english",logo:"üáØüáµ"},
  {name:"Thermofin",country:"Canada",types:["ac","finned"],spec:"A√©ror√©frig√©rants, tubes ailet√©s",url:"https://www.thermofin.com",logo:"üá®üá¶"},
];

// ===================== R√âSULTATS GLOBAUX =====================
let R = {}; // r√©sultats du dernier calcul
let charts = {}; // instances Chart.js

// ===================== NAVIGATION =====================
function sp(id) {
  document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
  document.getElementById('p-'+id).classList.add('active');
  const tabs = document.querySelectorAll('.nav-tab');
  const names = ['saisie','resultats','geometrie','courbes','fournisseurs','datasheet','rapport'];
  const idx = names.indexOf(id);
  if (idx >= 0) tabs[idx].classList.add('active');
}

// ===================== INIT : POPULATE FLUID SELECTS =====================
function initFluids() {
  ['hFluid','cFluid'].forEach(selId => {
    const sel = document.getElementById(selId);
    Object.keys(FLUIDS).forEach(k => {
      const o = document.createElement('option');
      o.value = k; o.textContent = FLUIDS[k].name;
      sel.appendChild(o);
    });
  });
}

function onFluidChange(side) {
  const v = document.getElementById(side+'Fluid').value;
  document.getElementById(side+'Manual').style.display = (v==='custom') ? 'grid' : 'none';
  if (v && v !== 'custom' && FOULING_DEFAULTS[v]) {
    document.getElementById(side==='h'?'foulH':'foulC').value = FOULING_DEFAULTS[v];
  }
}

function onStateChange(side) {
  const st = document.getElementById(side+'State').value;
  const show = (st==='condensation' || st==='evaporation');
  document.getElementById(side+'Phase').classList.toggle('show', show);
}

// ===================== UTILITAIRES =====================
function v(id) { return parseFloat(document.getElementById(id).value) || 0; }
function fmt(n, d=1) { return isNaN(n) ? '‚Äî' : n.toFixed(d); }
function fmtE(n, d=2) { return isNaN(n) ? '‚Äî' : n.toExponential(d); }

function getFluidProps(side) {
  const fid = document.getElementById(side+'Fluid').value;
  if (fid === 'custom') {
    return {
      name: 'Manuel',
      rho: v(side+'Rho'), mu: v(side+'Mu'), cp: v(side+'Cp'), lam: v(side+'Lambda'),
      pr: (v(side+'Mu')*1e-3 * v(side+'Cp')*1e3) / (v(side+'Lambda')||1),
      lat: v(side+'Lat'), cat: 'liquid'
    };
  }
  if (!fid || !FLUIDS[fid]) return null;
  const f = {...FLUIDS[fid]};
  const latInput = v(side+'Lat');
  if (latInput > 0) f.lat = latInput;
  return f;
}

// ===================== EXEMPLES =====================
function loadExample() {
  document.getElementById('hFluid').value = 'water'; onFluidChange('h');
  document.getElementById('hFlow').value = 10000;
  document.getElementById('hTin').value = 90;
  document.getElementById('hTout').value = 60;
  document.getElementById('hP').value = 3;
  document.getElementById('hState').value = 'liquid'; onStateChange('h');
  document.getElementById('cFluid').value = 'water'; onFluidChange('c');
  document.getElementById('cFlow').value = 15000;
  document.getElementById('cTin').value = 20;
  document.getElementById('cTout').value = 40;
  document.getElementById('cP').value = 3;
  document.getElementById('cState').value = 'liquid'; onStateChange('c');
  document.getElementById('flowConfig').value = 'counter';
}

function resetForm() {
  ['hFluid','cFluid'].forEach(id => document.getElementById(id).value = '');
  ['hFlow','hTin','hTout','cFlow','cTin','cTout'].forEach(id => document.getElementById(id).value = '');
  ['hManual','cManual'].forEach(id => document.getElementById(id).style.display = 'none');
  ['hPhase','cPhase'].forEach(id => document.getElementById(id).classList.remove('show'));
  document.getElementById('hState').value = 'liquid';
  document.getElementById('cState').value = 'liquid';
}

// ===================== MOTEUR DE CALCUL PRINCIPAL =====================
function calculate() {
  const ld = document.getElementById('ld');
  ld.classList.add('show');
  document.getElementById('ldT').textContent = 'Calculs en cours...';

  setTimeout(() => {
    try {
      doCalculation();
      ld.classList.remove('show');
      sp('resultats');
    } catch(e) {
      ld.classList.remove('show');
      alert('Erreur de calcul : ' + e.message);
      console.error(e);
    }
  }, 100);
}

function doCalculation() {
  const hf = getFluidProps('h');
  const cf = getFluidProps('c');
  if (!hf || !cf) throw new Error('S√©lectionnez les fluides c√¥t√© chaud et froid.');

  const hFlow = v('hFlow');     // kg/h
  const hTin = v('hTin');
  const hTout = v('hTout');
  const cFlow = v('cFlow');
  const cTin = v('cTin');
  const cTout = v('cTout');
  const hState = document.getElementById('hState').value;
  const cState = document.getElementById('cState').value;
  const config = document.getElementById('flowConfig').value;
  const overdesign = v('overdesign') / 100;
  const foulH = v('foulH');
  const foulC = v('foulC');
  const matTube = document.getElementById('matTube').value;
  const matShell = document.getElementById('matShell').value;

  // Validation
  if (hFlow <= 0 || cFlow <= 0) throw new Error('Les d√©bits doivent √™tre > 0.');
  if (hTin <= hTout && (hState==='liquid'||hState==='gas')) throw new Error('C√¥t√© chaud : T entr√©e doit √™tre > T sortie.');
  if (cTout <= cTin && (cState==='liquid'||cState==='gas')) throw new Error('C√¥t√© froid : T sortie doit √™tre > T entr√©e.');

  // === PUISSANCE THERMIQUE ===
  let Qh, Qc;
  if (hState === 'condensation') {
    const xIn = v('hXin'), xOut = v('hXout');
    const Qlat = hFlow / 3600 * hf.lat * (xIn - xOut);
    const Qsens = hFlow / 3600 * hf.cp * (hTin - hTout);
    Qh = Qlat + Qsens;
  } else if (hState === 'evaporation') {
    const xIn = v('hXin'), xOut = v('hXout');
    const Qlat = hFlow / 3600 * hf.lat * (xOut - xIn);
    const Qsens = hFlow / 3600 * hf.cp * Math.abs(hTin - hTout);
    Qh = Qlat + Qsens;
  } else {
    Qh = hFlow / 3600 * hf.cp * Math.abs(hTin - hTout);
  }

  if (cState === 'evaporation') {
    const xIn = v('cXin'), xOut = v('cXout');
    const Qlat = cFlow / 3600 * cf.lat * (xOut - xIn);
    const Qsens = cFlow / 3600 * cf.cp * Math.abs(cTout - cTin);
    Qc = Qlat + Qsens;
  } else if (cState === 'condensation') {
    const xIn = v('cXin'), xOut = v('cXout');
    const Qlat = cFlow / 3600 * cf.lat * (xIn - xOut);
    const Qsens = cFlow / 3600 * cf.cp * Math.abs(cTout - cTin);
    Qc = Qlat + Qsens;
  } else {
    Qc = cFlow / 3600 * cf.cp * Math.abs(cTout - cTin);
  }

  const Q = (Qh + Qc) / 2; // kW ‚Äî moyenne

  // === DTLM ===
  let dT1, dT2;
  if (config === 'parallel') {
    dT1 = hTin - cTin;
    dT2 = hTout - cTout;
  } else {
    dT1 = hTin - cTout;
    dT2 = hTout - cTin;
  }
  if (dT1 <= 0 || dT2 <= 0) throw new Error('Croisement de temp√©rature d√©tect√©. V√©rifiez les temp√©ratures.');
  let LMTD;
  if (Math.abs(dT1 - dT2) < 0.01) {
    LMTD = dT1;
  } else {
    LMTD = (dT1 - dT2) / Math.log(dT1 / dT2);
  }

  // === FACTEUR DE CORRECTION F ===
  let F = 1.0;
  if (config === 'shell12' || config === 'shell24') {
    const P_r = (cTout - cTin) / (hTin - cTin);
    const R_r = (hTin - hTout) / (cTout - cTin);
    if (config === 'shell12') {
      F = calcF_1_2(P_r, R_r);
    } else {
      F = calcF_2_4(P_r, R_r);
    }
  } else if (config === 'crossflow') {
    F = 0.9; // approximation courante
  }

  const LMTD_corr = LMTD * F;

  // === COEFFICIENT U ESTIM√â ===
  const hCat = (hState==='condensation') ? 'condensation' : (hState==='gas'?'gas':'liquid');
  const cCat = (cState==='evaporation') ? 'evaporation' : (cState==='gas'?'gas':'liquid');
  let uKey = hCat + '-' + cCat;
  if (!U_TABLE[uKey]) uKey = cCat + '-' + hCat;
  if (!U_TABLE[uKey]) uKey = 'liquid-liquid';
  const Uref = U_TABLE[uKey];

  // === COEFFICIENTS INDIVIDUELS (corr√©lations) ===
  // G√©om√©trie tubes standard
  const tubeOD = 0.01905; // 3/4" = 19.05 mm
  const tubeID = 0.01575; // BWG 14
  const tubeWall = (tubeOD - tubeID) / 2;
  const tubePitch = tubeOD * 1.25; // triangulaire 30¬∞
  const Ltube = 4.88; // 16 ft standard
  const nPasses = (config==='shell12') ? 2 : (config==='shell24' ? 4 : 2);

  // hi ‚Äî c√¥t√© tube (Dittus-Boelter / Sieder-Tate)
  let hi;
  const tubeSideFluid = cf; // convention : froid c√¥t√© tubes
  const Atube = Math.PI * tubeID * tubeID / 4;
  const vTube_init = (cFlow / 3600) / (tubeSideFluid.rho * Atube * 100); // vitesse approx pour 100 tubes
  const Re_tube = tubeSideFluid.rho * 1.5 * tubeID / (tubeSideFluid.mu * 1e-3);
  if (cState === 'evaporation') {
    hi = 2000; // corr√©lation √©bullition simplifi√©e
  } else if (Re_tube > 10000) {
    const n_exp = (cState==='liquid' && cTout > cTin) ? 0.4 : 0.3;
    hi = 0.023 * Math.pow(Re_tube, 0.8) * Math.pow(tubeSideFluid.pr, n_exp) * tubeSideFluid.lam / tubeID;
  } else if (Re_tube > 2300) {
    hi = 0.116 * (Math.pow(Re_tube, 2/3) - 125) * Math.pow(tubeSideFluid.pr, 1/3) * tubeSideFluid.lam / tubeID;
  } else {
    hi = 3.66 * tubeSideFluid.lam / tubeID;
  }

  // ho ‚Äî c√¥t√© calandre (Kern)
  let ho;
  const shellSideFluid = hf;
  if (hState === 'condensation') {
    // Nusselt film condensation
    ho = 0.725 * Math.pow(
      shellSideFluid.rho * (shellSideFluid.rho - 1) * 9.81 * shellSideFluid.lat * 1000 *
      Math.pow(shellSideFluid.lam, 3) /
      (shellSideFluid.mu * 1e-3 * tubeOD * Math.max(Math.abs(hTin - hTout), 1)),
      0.25
    );
    ho = Math.min(ho, 12000); // plafonnement r√©aliste
  } else {
    const De = 4 * (tubePitch * tubePitch * Math.sqrt(3) / 4 - Math.PI * tubeOD * tubeOD / 8) / (Math.PI * tubeOD / 2);
    const Re_shell = shellSideFluid.rho * 0.8 * De / (shellSideFluid.mu * 1e-3);
    if (Re_shell > 2000) {
      ho = 0.36 * Math.pow(Re_shell, 0.55) * Math.pow(shellSideFluid.pr, 1/3) * shellSideFluid.lam / De;
    } else {
      ho = 0.8 * shellSideFluid.lam / De * Math.pow(Re_shell * shellSideFluid.pr * De / Ltube, 1/3);
    }
  }

  hi = Math.max(hi, 50);
  ho = Math.max(ho, 20);

  // U calcul√©
  const kWall = MAT_COND[matTube] || 50;
  const Uo_calc = 1 / (1/ho + foulH + tubeWall/kWall + foulC + tubeOD/(tubeID * hi));
  const Uo = Math.min(Uo_calc, Uref.high);

  // === SURFACE D'√âCHANGE ===
  const A_net = (Q * 1000) / (Uo * LMTD_corr);
  const A_design = A_net * (1 + overdesign);

  // === G√âOM√âTRIE TUBES & CALANDRE ===
  const nTubes = Math.ceil(A_design / (Math.PI * tubeOD * Ltube));
  const nTubesPerPass = Math.ceil(nTubes / nPasses);
  const CTP = 0.93; // tube count constant (1 pass)
  const CL = 1.0; // triangulaire
  const Ds = tubeOD * Math.sqrt(nTubes * CL / (CTP * 0.785)) / 0.85 * tubePitch / tubeOD;
  const Ds_round = Math.ceil(Ds * 1000 / 50) * 50 / 1000; // arrondi au 50mm

  // Vitesses
  const vTube = (cFlow / 3600) / (cf.rho * nTubesPerPass * Atube);
  const shellArea = Ds_round * (tubePitch - tubeOD) * 0.4; // approximation
  const vShell = (hFlow / 3600) / (hf.rho * Math.max(shellArea, 0.001));

  // Pertes de charge
  const fTube = 0.046 * Math.pow(Math.max(Re_tube,1000), -0.2);
  const dP_tube = (4 * fTube * Ltube / tubeID + 4) * nPasses * cf.rho * vTube * vTube / 2 / 1000;
  const dP_shell = hf.rho * vShell * vShell / 2 * (Ltube / (0.4 * Ds_round) + 2) * 0.5 / 1000;

  // === Œµ-NTU ===
  const Ch = hFlow / 3600 * hf.cp * 1000; // W/K
  const Cc = cFlow / 3600 * cf.cp * 1000;
  const Cmin = Math.min(Ch, Cc);
  const Cmax = Math.max(Ch, Cc);
  const Cr = Cmin / Cmax;
  const NTU = Uo * A_design / Cmin;
  let epsilon;
  if (Cr < 0.01) {
    epsilon = 1 - Math.exp(-NTU);
  } else if (config === 'parallel') {
    epsilon = (1 - Math.exp(-NTU * (1 + Cr))) / (1 + Cr);
  } else {
    epsilon = (1 - Math.exp(-NTU * (1 - Cr))) / (1 - Cr * Math.exp(-NTU * (1 - Cr)));
  }
  epsilon = Math.min(epsilon, 1);

  // === S√âLECTION TYPE D'√âCHANGEUR ===
  const Pmax = Math.max(v('hP'), v('cP'));
  const Tmax = Math.max(hTin, cTout);
  const hasPhaseChange = (hState==='condensation' || hState==='evaporation' || cState==='condensation' || cState==='evaporation');
  const isViscous = (hf.mu > 10 || cf.mu > 10);
  const isCorrosive = ['h2so4_98','h2so4_70','hcl_30','naoh_50','naoh_30'].includes(document.getElementById('hFluid').value) ||
                      ['h2so4_98','h2so4_70','hcl_30','naoh_50','naoh_30'].includes(document.getElementById('cFluid').value);

  let hxType, hxTypeTag, hxReason, hxAlternatives;
  if (Pmax > 30 || Tmax > 300 || hasPhaseChange) {
    hxType = 'Tubes & Calandre (Shell & Tube)';
    hxTypeTag = 'st';
    hxReason = [];
    if (Pmax > 30) hxReason.push('Pression √©lev√©e (>' + 30 + ' bar)');
    if (Tmax > 300) hxReason.push('Temp√©rature √©lev√©e (>' + 300 + '¬∞C)');
    if (hasPhaseChange) hxReason.push('Changement de phase');
    hxAlternatives = ['Plate & Shell (Vahterus) si P < 100 bar'];
  } else if (isViscous) {
    hxType = '√âchangeur spirale';
    hxTypeTag = 'sp';
    hxReason = ['Fluide visqueux (Œº > 10 mPa¬∑s)','Bon pour encrassement'];
    hxAlternatives = ['Tubes & calandre avec chicanes rapproch√©es','√âchangeur racl√© (HRS)'];
  } else if (Pmax <= 25 && Tmax <= 150 && !hasPhaseChange) {
    hxType = '√âchangeur √† plaques (PHE)';
    hxTypeTag = 'phe';
    hxReason = ['Compact et efficace','Liquide-liquide, P < 25 bar, T < 150¬∞C'];
    hxAlternatives = ['Plaques bras√©es (SWEP) si < 30 bar','Tubes & calandre'];
  } else if (v('cFluid') === '' && cState === 'gas') {
    hxType = 'A√©ror√©frig√©rant (Air-cooled)';
    hxTypeTag = 'ac';
    hxReason = ['Refroidissement par air ambiant','Pas de fluide de refroidissement n√©cessaire'];
    hxAlternatives = ['Tubes & calandre avec eau de refroidissement'];
  } else {
    hxType = 'Tubes & Calandre (Shell & Tube)';
    hxTypeTag = 'st';
    hxReason = ['Configuration standard polyvalente'];
    hxAlternatives = ['√âchangeur √† plaques si conditions mod√©r√©es'];
  }

  // === D√âSIGNATION TEMA ===
  let temaType;
  if (hasPhaseChange && hState === 'condensation') temaType = 'AES';
  else if (hasPhaseChange && cState === 'evaporation') temaType = 'AKT';
  else if (Tmax > 200) temaType = 'BEM';
  else temaType = 'AES';

  // === STOCKER R√âSULTATS ===
  R = {
    Q, Qh, Qc, LMTD, F, LMTD_corr, Uo, Uref, A_net, A_design,
    hi, ho, kWall, foulH, foulC,
    nTubes, nPasses, nTubesPerPass, tubeOD: tubeOD*1000, tubeID: tubeID*1000, Ltube,
    Ds: Ds_round*1000, tubePitch: tubePitch*1000,
    vTube, vShell, Re_tube, dP_tube, dP_shell,
    NTU, Cr, epsilon, Cmin, Cmax,
    hxType, hxTypeTag, hxReason, hxAlternatives, temaType,
    hf, cf, hState, cState, config,
    hFlow, hTin, hTout, cFlow, cTin, cTout,
    Pmax, Tmax, matTube, matShell, overdesign,
    hasPhaseChange, isViscous, isCorrosive
  };

  renderResults();
  renderGeometry();
  renderCurves();
  renderSuppliers();
  renderSpec();
  renderReport();
}

// ===================== FACTEUR F (1-2 shell) =====================
function calcF_1_2(P, R) {
  if (P <= 0 || P >= 1 || R <= 0) return 1;
  if (Math.abs(R - 1) < 0.01) {
    const S = P / (1 - P + P / Math.sqrt(2));
    return Math.sqrt(2) * (1 - S) / ((1 - S) > 0 ? Math.log((1)/(1-S)) : 1);
  }
  const S = Math.sqrt(R*R + 1);
  const W = ((1 - P*R)/(1 - P));
  if (W <= 0) return 0.75;
  const num = S * Math.log(W) / (R - 1);
  const A = (2/P - 1 - R + S) / (2/P - 1 - R - S);
  if (A <= 0) return 0.75;
  const den = Math.log(A);
  if (Math.abs(den) < 1e-6) return 1;
  return Math.max(0.5, Math.min(1, num / den));
}

function calcF_2_4(P, R) {
  const P1 = (1 - Math.pow((1-P*R)/(1-P), 0.5)) / (R - Math.pow((1-P*R)/(1-P), 0.5));
  return calcF_1_2(P1, R);
}

// ===================== RENDU R√âSULTATS =====================
function renderResults() {
  document.getElementById('noResults').style.display = 'none';
  document.getElementById('resultsContent').style.display = 'block';

  // Bilan thermique
  document.getElementById('rgThermal').innerHTML = `
    <div class="ri"><div class="rv">${fmt(R.Q,1)}</div><div class="rl">Puissance thermique</div><div class="ru">kW</div></div>
    <div class="ri"><div class="rv">${fmt(R.LMTD,1)}</div><div class="rl">DTLM</div><div class="ru">¬∞C</div></div>
    <div class="ri"><div class="rv">${fmt(R.F,3)}</div><div class="rl">Facteur F</div><div class="ru">‚Äî</div></div>
    <div class="ri"><div class="rv">${fmt(R.LMTD_corr,1)}</div><div class="rl">DTLM corrig√©</div><div class="ru">¬∞C</div></div>
    <div class="ri"><div class="rv">${fmt(R.Uo,0)}</div><div class="rl">U global</div><div class="ru">W/(m¬≤¬∑K)</div></div>
    <div class="ri"><div class="rv">${fmt(R.A_net,1)}</div><div class="rl">Surface nette</div><div class="ru">m¬≤</div></div>
    <div class="ri"><div class="rv">${fmt(R.A_design,1)}</div><div class="rl">Surface design (+${R.overdesign*100}%)</div><div class="ru">m¬≤</div></div>
    <div class="ri"><div class="rv">${fmt(R.epsilon*100,1)}</div><div class="rl">Efficacit√© Œµ</div><div class="ru">%</div></div>
  `;

  // Type recommand√©
  const tagClass = {'st':'tag-st','phe':'tag-phe','sp':'tag-sp','ac':'tag-ac','dp':'tag-dp'};
  document.getElementById('hxTypeRecommendation').innerHTML = `
    <div style="display:flex;align-items:center;gap:1rem;margin-bottom:1rem">
      <span style="font-size:2rem">${R.hxTypeTag==='st'?'üî©':R.hxTypeTag==='phe'?'üì¶':R.hxTypeTag==='sp'?'üåÄ':R.hxTypeTag==='ac'?'üí®':'üîß'}</span>
      <div>
        <div style="font-size:1.3rem;font-weight:700;color:var(--acc)">${R.hxType}</div>
        ${R.temaType ? '<span class="tag tag-st">TEMA '+R.temaType+'</span>' : ''}
      </div>
    </div>
    <div class="okb"><strong>Justification :</strong><ul>${R.hxReason.map(r=>'<li>'+r+'</li>').join('')}</ul></div>
    <div class="ib"><strong>Alternatives :</strong><ul>${R.hxAlternatives.map(a=>'<li>'+a+'</li>').join('')}</ul></div>
  `;

  // Dimensionnement
  document.getElementById('rgSizing').innerHTML = `
    <div class="ri"><div class="rv">${R.nTubes}</div><div class="rl">Nombre de tubes</div></div>
    <div class="ri"><div class="rv">${R.nPasses}</div><div class="rl">Passes tubes</div></div>
    <div class="ri"><div class="rv">${fmt(R.tubeOD,1)}√ó${fmt(R.tubeID,1)}</div><div class="rl">Tubes OD √ó ID</div><div class="ru">mm</div></div>
    <div class="ri"><div class="rv">${fmt(R.Ltube,2)}</div><div class="rl">Longueur tubes</div><div class="ru">m</div></div>
    <div class="ri"><div class="rv">${fmt(R.Ds,0)}</div><div class="rl">√ò Calandre</div><div class="ru">mm</div></div>
    <div class="ri"><div class="rv">${fmt(R.tubePitch,1)}</div><div class="rl">Pitch tubes</div><div class="ru">mm</div></div>
  `;

  // Hydraulique
  const dPhOK = R.dP_tube <= v('dPh');
  const dPcOK = R.dP_shell <= v('dPc');
  document.getElementById('rgHydraulic').innerHTML = `
    <div class="ri"><div class="rv">${fmt(R.vTube,2)}</div><div class="rl">Vitesse tubes</div><div class="ru">m/s</div></div>
    <div class="ri"><div class="rv">${fmt(R.vShell,2)}</div><div class="rl">Vitesse calandre</div><div class="ru">m/s</div></div>
    <div class="ri"><div class="rv">${fmt(R.Re_tube,0)}</div><div class="rl">Re tubes</div><div class="ru">${R.Re_tube>10000?'Turbulent':R.Re_tube>2300?'Transition':'Laminaire'}</div></div>
    <div class="ri"><div class="rv" style="color:${dPhOK?'var(--ok)':'var(--err)'}">${fmt(R.dP_tube,1)}</div><div class="rl">ŒîP c√¥t√© tubes</div><div class="ru">kPa</div></div>
    <div class="ri"><div class="rv" style="color:${dPcOK?'var(--ok)':'var(--err)'}">${fmt(R.dP_shell,1)}</div><div class="rl">ŒîP c√¥t√© calandre</div><div class="ru">kPa</div></div>
  `;
  let alerts = '';
  if (!dPhOK) alerts += '<div class="eb">‚ö†Ô∏è ŒîP tubes ('+fmt(R.dP_tube,1)+' kPa) d√©passe la limite admissible ('+v('dPh')+' kPa). Augmenter le nombre de tubes ou r√©duire les passes.</div>';
  if (!dPcOK) alerts += '<div class="eb">‚ö†Ô∏è ŒîP calandre ('+fmt(R.dP_shell,1)+' kPa) d√©passe la limite admissible ('+v('dPc')+' kPa). Augmenter le diam√®tre calandre ou l\'espacement des chicanes.</div>';
  if (R.vTube > 3) alerts += '<div class="wb">‚ö° Vitesse tubes √©lev√©e ('+fmt(R.vTube,1)+' m/s). Risque d\'√©rosion si > 3 m/s.</div>';
  if (R.vTube < 0.5) alerts += '<div class="wb">‚ö° Vitesse tubes faible ('+fmt(R.vTube,2)+' m/s). Risque d\'encrassement acc√©l√©r√© si < 0.5 m/s.</div>';
  document.getElementById('hydraulicAlerts').innerHTML = alerts;

  // Coefficients
  document.getElementById('rgCoeff').innerHTML = `
    <div class="ri"><div class="rv">${fmt(R.hi,0)}</div><div class="rl">hi (c√¥t√© tubes)</div><div class="ru">W/(m¬≤¬∑K)</div></div>
    <div class="ri"><div class="rv">${fmt(R.ho,0)}</div><div class="rl">ho (c√¥t√© calandre)</div><div class="ru">W/(m¬≤¬∑K)</div></div>
    <div class="ri"><div class="rv">${fmt(R.kWall,1)}</div><div class="rl">k paroi (${MAT_NAMES[R.matTube]})</div><div class="ru">W/(m¬∑K)</div></div>
    <div class="ri"><div class="rv">${fmtE(R.foulH)}</div><div class="rl">Fouling chaud</div><div class="ru">m¬≤¬∑K/W</div></div>
    <div class="ri"><div class="rv">${fmtE(R.foulC)}</div><div class="rl">Fouling froid</div><div class="ru">m¬≤¬∑K/W</div></div>
    <div class="ri"><div class="rv">${fmt(R.NTU,2)}</div><div class="rl">NTU</div></div>
  `;
}

// ===================== RENDU G√âOM√âTRIE =====================
function renderGeometry() {
  document.getElementById('noGeom').style.display = 'none';
  document.getElementById('geomContent').style.display = 'block';

  const temaTypes = {
    'AES': {front:'A ‚Äî T√™te √† chapeau amovible', shell:'E ‚Äî 1 passe calandre', rear:'S ‚Äî T√™te flottante interne'},
    'BEM': {front:'B ‚Äî T√™te √† calotte', shell:'E ‚Äî 1 passe calandre', rear:'M ‚Äî Plaque tubulaire fixe'},
    'AKT': {front:'A ‚Äî T√™te √† chapeau amovible', shell:'K ‚Äî Bouilloire (kettle)', rear:'T ‚Äî T√™te flottante √† bride'},
  };
  const tema = temaTypes[R.temaType] || temaTypes['AES'];

  document.getElementById('geomParams').innerHTML = `
    <table class="rt">
      <tr><th colspan="2">G√©om√©trie Tubes & Calandre ‚Äî TEMA ${R.temaType}</th></tr>
      <tr><td>Type avant</td><td>${tema.front}</td></tr>
      <tr><td>Type calandre</td><td>${tema.shell}</td></tr>
      <tr><td>Type arri√®re</td><td>${tema.rear}</td></tr>
      <tr><th colspan="2">Dimensions</th></tr>
      <tr><td>Diam√®tre calandre</td><td>${fmt(R.Ds,0)} mm</td></tr>
      <tr><td>Nombre de tubes</td><td>${R.nTubes}</td></tr>
      <tr><td>Longueur tubes</td><td>${fmt(R.Ltube*1000,0)} mm</td></tr>
      <tr><td>Tubes OD √ó √©paisseur</td><td>${fmt(R.tubeOD,2)} √ó ${fmt((R.tubeOD-R.tubeID)/2,2)} mm</td></tr>
      <tr><td>Pitch (pas)</td><td>${fmt(R.tubePitch,2)} mm ‚Äî Triangulaire 30¬∞</td></tr>
      <tr><td>Passes tubes</td><td>${R.nPasses}</td></tr>
      <tr><td>Chicanes (baffles)</td><td>Segment√©es 25% ‚Äî espacement ${fmt(R.Ds*0.4,0)} mm</td></tr>
      <tr><th colspan="2">Mat√©riaux</th></tr>
      <tr><td>Tubes</td><td>${MAT_NAMES[R.matTube]}</td></tr>
      <tr><td>Calandre</td><td>${MAT_NAMES[R.matShell]}</td></tr>
      <tr><th colspan="2">Surface d'√©change</th></tr>
      <tr><td>Surface nette calcul√©e</td><td>${fmt(R.A_net,2)} m¬≤</td></tr>
      <tr><td>Surface avec surdesign</td><td>${fmt(R.A_design,2)} m¬≤ (+${R.overdesign*100}%)</td></tr>
    </table>
  `;

  // SVG sch√©ma simplifi√©
  renderHXsvg();

  // R√©f√©rence TEMA
  document.getElementById('temaRef').innerHTML = `
    <div class="ib">
      <strong>Nomenclature TEMA :</strong> 3 lettres d√©crivant la t√™te avant + calandre + t√™te arri√®re.<br>
      Exemples courants : <strong>AES</strong> (standard), <strong>BEM</strong> (fixe, √©conomique), <strong>AEL</strong> (tube fixe),
      <strong>AKT</strong> (bouilloire/rebouilleur), <strong>CFU</strong> (2 passes calandre, U-tubes).
    </div>
  `;
}

function renderHXsvg() {
  const w = 700, h = 300;
  const Ds = Math.min(200, Math.max(80, R.Ds / 5));
  const Lt = 400;
  const x0 = 100, y0 = (h - Ds) / 2;

  let svg = `<svg viewBox="0 0 ${w} ${h}" style="width:100%;max-height:300px" xmlns="http://www.w3.org/2000/svg">`;
  svg += `<defs><linearGradient id="gShell" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="#3b82f6" stop-opacity="0.3"/><stop offset="100%" stop-color="#1e40af" stop-opacity="0.3"/></linearGradient></defs>`;

  // Calandre
  svg += `<rect x="${x0}" y="${y0}" width="${Lt}" height="${Ds}" rx="10" fill="url(#gShell)" stroke="#60a5fa" stroke-width="2"/>`;

  // Tubes (quelques lignes)
  const nLines = Math.min(8, R.nTubes);
  for (let i = 0; i < nLines; i++) {
    const ty = y0 + 15 + i * (Ds - 30) / (nLines - 1);
    svg += `<line x1="${x0+20}" y1="${ty}" x2="${x0+Lt-20}" y2="${ty}" stroke="#f59e0b" stroke-width="1.5" opacity="0.6"/>`;
  }

  // Chicanes
  for (let i = 1; i <= 4; i++) {
    const bx = x0 + i * Lt / 5;
    const cut = Ds * 0.25;
    if (i % 2 === 1) {
      svg += `<line x1="${bx}" y1="${y0}" x2="${bx}" y2="${y0+Ds-cut}" stroke="#94a3b8" stroke-width="2"/>`;
    } else {
      svg += `<line x1="${bx}" y1="${y0+cut}" x2="${bx}" y2="${y0+Ds}" stroke="#94a3b8" stroke-width="2"/>`;
    }
  }

  // Nozzles
  svg += `<rect x="${x0+60}" y="${y0-25}" width="20" height="25" fill="none" stroke="#ef4444" stroke-width="2"/>`;
  svg += `<text x="${x0+70}" y="${y0-30}" text-anchor="middle" fill="#ef4444" font-size="10">Hot in</text>`;
  svg += `<rect x="${x0+Lt-80}" y="${y0+Ds}" width="20" height="25" fill="none" stroke="#ef4444" stroke-width="2"/>`;
  svg += `<text x="${x0+Lt-70}" y="${y0+Ds+40}" text-anchor="middle" fill="#ef4444" font-size="10">Hot out</text>`;

  // T√™tes
  svg += `<path d="M${x0},${y0} Q${x0-30},${y0+Ds/2} ${x0},${y0+Ds}" fill="none" stroke="#60a5fa" stroke-width="2"/>`;
  svg += `<path d="M${x0+Lt},${y0} Q${x0+Lt+30},${y0+Ds/2} ${x0+Lt},${y0+Ds}" fill="none" stroke="#60a5fa" stroke-width="2"/>`;

  // Cold in/out
  svg += `<line x1="${x0+Lt+30}" y1="${y0+Ds*0.3}" x2="${x0+Lt+60}" y2="${y0+Ds*0.3}" stroke="#3b82f6" stroke-width="2" marker-end="url(#arr)"/>`;
  svg += `<text x="${x0+Lt+65}" y="${y0+Ds*0.3+4}" fill="#3b82f6" font-size="10">Cold in</text>`;
  svg += `<line x1="${x0-30}" y1="${y0+Ds*0.7}" x2="${x0-60}" y2="${y0+Ds*0.7}" stroke="#3b82f6" stroke-width="2"/>`;
  svg += `<text x="${x0-90}" y="${y0+Ds*0.7+4}" fill="#3b82f6" font-size="10">Cold out</text>`;

  // Labels
  svg += `<text x="${x0+Lt/2}" y="${h-10}" text-anchor="middle" fill="#94a3b8" font-size="11">TEMA ${R.temaType} ‚Äî √ò${fmt(R.Ds,0)}mm √ó ${fmt(R.Ltube*1000,0)}mm ‚Äî ${R.nTubes} tubes</text>`;

  svg += `</svg>`;
  document.getElementById('geomSVG').innerHTML = svg;
}

// ===================== RENDU COURBES =====================
function renderCurves() {
  document.getElementById('noCurves').style.display = 'none';
  document.getElementById('curvesContent').style.display = 'block';

  // D√©truire les anciens graphiques
  Object.values(charts).forEach(c => c.destroy());
  charts = {};

  // 1. Profil de temp√©rature
  const nPts = 20;
  const xData = [], hotT = [], coldT = [];
  for (let i = 0; i <= nPts; i++) {
    const frac = i / nPts;
    xData.push(fmt(frac * R.A_design, 1));
    hotT.push(R.hTin - frac * (R.hTin - R.hTout));
    coldT.push(R.config === 'counter'
      ? R.cTout - frac * (R.cTout - R.cTin)
      : R.cTin + frac * (R.cTout - R.cTin));
  }
  charts.temp = new Chart(document.getElementById('chartTemp'), {
    type: 'line',
    data: {
      labels: xData,
      datasets: [
        {label: 'C√¥t√© chaud', data: hotT, borderColor: '#ef4444', backgroundColor: 'rgba(239,68,68,0.1)', fill: true, tension: 0.3},
        {label: 'C√¥t√© froid', data: coldT, borderColor: '#3b82f6', backgroundColor: 'rgba(59,130,246,0.1)', fill: true, tension: 0.3}
      ]
    },
    options: {responsive:true,maintainAspectRatio:false,plugins:{legend:{labels:{color:'#94a3b8'}}},scales:{x:{title:{display:true,text:'Surface (m¬≤)',color:'#94a3b8'},ticks:{color:'#64748b'}},y:{title:{display:true,text:'Temp√©rature (¬∞C)',color:'#94a3b8'},ticks:{color:'#64748b'}}}}
  });

  // 2. Œµ vs NTU
  const ntuData = [], epsData = [], epsCr0 = [], epsCr05 = [], epsCr1 = [];
  for (let i = 0; i <= 50; i++) {
    const ntu = i * 0.1;
    ntuData.push(fmt(ntu,1));
    [0, 0.5, 1].forEach((cr, idx) => {
      let ep;
      if (cr < 0.01) ep = 1 - Math.exp(-ntu);
      else if (Math.abs(cr-1) < 0.01) ep = ntu / (1 + ntu);
      else ep = (1 - Math.exp(-ntu*(1-cr))) / (1 - cr*Math.exp(-ntu*(1-cr)));
      [epsCr0, epsCr05, epsCr1][idx].push(ep * 100);
    });
  }
  charts.ntu = new Chart(document.getElementById('chartNTU'), {
    type: 'line',
    data: {
      labels: ntuData,
      datasets: [
        {label: 'Cr=0 (condenseur)', data: epsCr0, borderColor: '#10b981', borderWidth: 1.5, pointRadius: 0, tension: 0.3},
        {label: 'Cr=0.5', data: epsCr05, borderColor: '#f59e0b', borderWidth: 1.5, pointRadius: 0, tension: 0.3},
        {label: 'Cr=1', data: epsCr1, borderColor: '#ef4444', borderWidth: 1.5, pointRadius: 0, tension: 0.3},
        {label: 'Point de fonctionnement', data: ntuData.map((n,i) => Math.abs(parseFloat(n)-R.NTU)<0.1 ? R.epsilon*100 : null), borderColor: '#fff', backgroundColor: '#f59e0b', pointRadius: 8, pointStyle: 'star', showLine: false}
      ]
    },
    options: {responsive:true,maintainAspectRatio:false,plugins:{legend:{labels:{color:'#94a3b8'}}},scales:{x:{title:{display:true,text:'NTU',color:'#94a3b8'},ticks:{color:'#64748b',maxTicksLimit:10}},y:{title:{display:true,text:'Efficacit√© Œµ (%)',color:'#94a3b8'},ticks:{color:'#64748b'},min:0,max:100}}}
  });

  // 3. ŒîP vs D√©bit
  const flowMult = [], dpTubeData = [], dpShellData = [];
  for (let i = 2; i <= 20; i++) {
    const mult = i / 10;
    flowMult.push(fmt(mult * 100, 0) + '%');
    dpTubeData.push(R.dP_tube * mult * mult);
    dpShellData.push(R.dP_shell * mult * mult);
  }
  charts.dp = new Chart(document.getElementById('chartDP'), {
    type: 'line',
    data: {
      labels: flowMult,
      datasets: [
        {label: 'ŒîP tubes (kPa)', data: dpTubeData, borderColor: '#3b82f6', tension: 0.3, pointRadius: 2},
        {label: 'ŒîP calandre (kPa)', data: dpShellData, borderColor: '#ef4444', tension: 0.3, pointRadius: 2}
      ]
    },
    options: {responsive:true,maintainAspectRatio:false,plugins:{legend:{labels:{color:'#94a3b8'}}},scales:{x:{title:{display:true,text:'D√©bit (% nominal)',color:'#94a3b8'},ticks:{color:'#64748b'}},y:{title:{display:true,text:'ŒîP (kPa)',color:'#94a3b8'},ticks:{color:'#64748b'}}}}
  });

  // 4. U vs D√©bit
  const uData = [];
  for (let i = 2; i <= 20; i++) {
    const mult = i / 10;
    uData.push(R.Uo * Math.pow(mult, 0.8));
  }
  charts.u = new Chart(document.getElementById('chartU'), {
    type: 'line',
    data: {
      labels: flowMult,
      datasets: [
        {label: 'U global (W/m¬≤¬∑K)', data: uData, borderColor: '#f59e0b', backgroundColor: 'rgba(245,158,11,0.1)', fill: true, tension: 0.3, pointRadius: 2}
      ]
    },
    options: {responsive:true,maintainAspectRatio:false,plugins:{legend:{labels:{color:'#94a3b8'}}},scales:{x:{title:{display:true,text:'D√©bit (% nominal)',color:'#94a3b8'},ticks:{color:'#64748b'}},y:{title:{display:true,text:'U (W/m¬≤¬∑K)',color:'#94a3b8'},ticks:{color:'#64748b'}}}}
  });

  // 5. Diagramme Q-T
  const qtLabels = ['0', fmt(R.Q*0.25,0), fmt(R.Q*0.5,0), fmt(R.Q*0.75,0), fmt(R.Q,0)];
  const qtHot = [R.hTin, R.hTin-(R.hTin-R.hTout)*0.25, R.hTin-(R.hTin-R.hTout)*0.5, R.hTin-(R.hTin-R.hTout)*0.75, R.hTout];
  const qtCold = [R.cTin, R.cTin+(R.cTout-R.cTin)*0.25, R.cTin+(R.cTout-R.cTin)*0.5, R.cTin+(R.cTout-R.cTin)*0.75, R.cTout];
  charts.qt = new Chart(document.getElementById('chartQT'), {
    type: 'line',
    data: {
      labels: qtLabels,
      datasets: [
        {label: 'Courbe chaude', data: qtHot, borderColor: '#ef4444', backgroundColor: 'rgba(239,68,68,0.15)', fill: '+1', tension: 0.1, pointRadius: 4},
        {label: 'Courbe froide', data: qtCold, borderColor: '#3b82f6', backgroundColor: 'rgba(59,130,246,0.15)', tension: 0.1, pointRadius: 4}
      ]
    },
    options: {responsive:true,maintainAspectRatio:false,plugins:{legend:{labels:{color:'#94a3b8'}}},scales:{x:{title:{display:true,text:'Puissance √©chang√©e Q (kW)',color:'#94a3b8'},ticks:{color:'#64748b'}},y:{title:{display:true,text:'Temp√©rature (¬∞C)',color:'#94a3b8'},ticks:{color:'#64748b'}}}}
  });
}

// ===================== RENDU FOURNISSEURS =====================
function renderSuppliers() {
  const typeMap = {'st':['st','custom','pshe'],'phe':['phe','bphe','welded','shellplate'],'sp':['spiral'],'ac':['ac','finned']};
  const relevantTypes = typeMap[R.hxTypeTag] || ['st','phe'];

  const filtered = SUPPLIERS.filter(s => s.types.some(t => relevantTypes.includes(t)));
  const others = SUPPLIERS.filter(s => !filtered.includes(s));

  document.getElementById('supplierFilter').innerHTML = `<strong>Type recommand√© :</strong> ${R.hxType} ‚Äî ${filtered.length} fournisseurs sp√©cialis√©s identifi√©s.`;

  let html = '<h3 style="color:var(--acc);margin:1rem 0 .5rem">Fournisseurs recommand√©s</h3><div class="supplier-grid">';
  filtered.forEach(s => {
    html += `<div class="supplier-card">
      <h4>${s.logo} ${s.name}</h4>
      <div class="country">${s.country}</div>
      <div class="spec">${s.spec}</div>
      <a href="${s.url}" target="_blank">üîó ${s.url.replace('https://','')}</a>
    </div>`;
  });
  html += '</div>';

  if (others.length > 0) {
    html += '<h3 style="color:var(--t3);margin:1.5rem 0 .5rem">Autres fournisseurs</h3><div class="supplier-grid">';
    others.forEach(s => {
      html += `<div class="supplier-card" style="opacity:0.6">
        <h4>${s.logo} ${s.name}</h4>
        <div class="country">${s.country}</div>
        <div class="spec">${s.spec}</div>
        <a href="${s.url}" target="_blank">üîó ${s.url.replace('https://','')}</a>
      </div>`;
    });
    html += '</div>';
  }

  document.getElementById('supplierGrid').innerHTML = html;
}

// ===================== RENDU FICHE DE SP√âCIFICATION =====================
function renderSpec() {
  document.getElementById('noSpec').style.display = 'none';
  document.getElementById('specContent').style.display = 'block';

  const today = new Date().toISOString().split('T')[0];
  document.getElementById('specSheet').innerHTML = `
  <div class="spec-sheet" id="specPrint">
    <h2>FICHE DE SP√âCIFICATION ‚Äî √âCHANGEUR DE CHALEUR</h2>
    <table>
      <tr class="section-title"><td colspan="4">1. INFORMATIONS G√âN√âRALES</td></tr>
      <tr><td width="25%">Client</td><td><input id="spClient" value=""></td><td width="25%">N¬∞ Document</td><td><input id="spDocNum" value="HX-${today.replace(/-/g,'')}-001"></td></tr>
      <tr><td>Projet</td><td><input id="spProject" value=""></td><td>R√©vision</td><td><input id="spRev" value="A"></td></tr>
      <tr><td>Service</td><td><input id="spService" value="${R.hf.name} / ${R.cf.name}"></td><td>Date</td><td>${today}</td></tr>
      <tr><td>Tag N¬∞</td><td><input id="spTag" value="E-"></td><td>Type TEMA</td><td>${R.temaType}</td></tr>

      <tr class="section-title"><td colspan="4">2. DONN√âES PROC√âD√â</td></tr>
      <tr><th></th><th>C√¥t√© Chaud (Calandre)</th><th>C√¥t√© Froid (Tubes)</th><th>Unit√©</th></tr>
      <tr><td>Fluide</td><td>${R.hf.name}</td><td>${R.cf.name}</td><td></td></tr>
      <tr><td>D√©bit massique</td><td>${fmt(R.hFlow,0)}</td><td>${fmt(R.cFlow,0)}</td><td>kg/h</td></tr>
      <tr><td>Temp√©rature entr√©e</td><td>${fmt(R.hTin,1)}</td><td>${fmt(R.cTin,1)}</td><td>¬∞C</td></tr>
      <tr><td>Temp√©rature sortie</td><td>${fmt(R.hTout,1)}</td><td>${fmt(R.cTout,1)}</td><td>¬∞C</td></tr>
      <tr><td>Pression service</td><td>${fmt(v('hP'),1)}</td><td>${fmt(v('cP'),1)}</td><td>bar abs</td></tr>
      <tr><td>√âtat</td><td>${R.hState}</td><td>${R.cState}</td><td></td></tr>
      <tr><td>Masse volumique</td><td>${fmt(R.hf.rho,0)}</td><td>${fmt(R.cf.rho,0)}</td><td>kg/m¬≥</td></tr>
      <tr><td>Viscosit√©</td><td>${fmt(R.hf.mu,2)}</td><td>${fmt(R.cf.mu,2)}</td><td>mPa¬∑s</td></tr>
      <tr><td>Cp</td><td>${fmt(R.hf.cp,2)}</td><td>${fmt(R.cf.cp,2)}</td><td>kJ/(kg¬∑K)</td></tr>
      <tr><td>Conductivit√©</td><td>${fmt(R.hf.lam,3)}</td><td>${fmt(R.cf.lam,3)}</td><td>W/(m¬∑K)</td></tr>
      <tr><td>Fouling</td><td>${fmtE(R.foulH)}</td><td>${fmtE(R.foulC)}</td><td>m¬≤¬∑K/W</td></tr>
      <tr><td>ŒîP admissible</td><td>${fmt(v('dPh'),0)}</td><td>${fmt(v('dPc'),0)}</td><td>kPa</td></tr>
      <tr><td>ŒîP calcul√©e</td><td>${fmt(R.dP_shell,1)}</td><td>${fmt(R.dP_tube,1)}</td><td>kPa</td></tr>

      <tr class="section-title"><td colspan="4">3. PERFORMANCES THERMIQUES</td></tr>
      <tr><td>Puissance thermique</td><td colspan="2">${fmt(R.Q,1)}</td><td>kW</td></tr>
      <tr><td>DTLM</td><td colspan="2">${fmt(R.LMTD,1)}</td><td>¬∞C</td></tr>
      <tr><td>Facteur de correction F</td><td colspan="2">${fmt(R.F,3)}</td><td></td></tr>
      <tr><td>DTLM corrig√©</td><td colspan="2">${fmt(R.LMTD_corr,1)}</td><td>¬∞C</td></tr>
      <tr><td>Coefficient U</td><td colspan="2">${fmt(R.Uo,0)}</td><td>W/(m¬≤¬∑K)</td></tr>
      <tr><td>Surface nette</td><td colspan="2">${fmt(R.A_net,2)}</td><td>m¬≤</td></tr>
      <tr><td>Surface design (+${R.overdesign*100}%)</td><td colspan="2">${fmt(R.A_design,2)}</td><td>m¬≤</td></tr>
      <tr><td>Efficacit√© Œµ</td><td colspan="2">${fmt(R.epsilon*100,1)}</td><td>%</td></tr>

      <tr class="section-title"><td colspan="4">4. CONSTRUCTION M√âCANIQUE</td></tr>
      <tr><td>Type d'√©changeur</td><td colspan="3">${R.hxType} ‚Äî TEMA ${R.temaType}</td></tr>
      <tr><td>Diam√®tre calandre</td><td colspan="2">${fmt(R.Ds,0)}</td><td>mm</td></tr>
      <tr><td>Nombre de tubes</td><td colspan="2">${R.nTubes}</td><td></td></tr>
      <tr><td>Dimensions tubes (OD√ó√©p)</td><td colspan="2">${fmt(R.tubeOD,2)} √ó ${fmt((R.tubeOD-R.tubeID)/2,2)}</td><td>mm</td></tr>
      <tr><td>Longueur tubes</td><td colspan="2">${fmt(R.Ltube*1000,0)}</td><td>mm</td></tr>
      <tr><td>Pas (pitch)</td><td colspan="2">${fmt(R.tubePitch,2)} ‚Äî Triangulaire 30¬∞</td><td>mm</td></tr>
      <tr><td>Passes tubes</td><td colspan="2">${R.nPasses}</td><td></td></tr>
      <tr><td>Mat√©riau tubes</td><td colspan="3">${MAT_NAMES[R.matTube]}</td></tr>
      <tr><td>Mat√©riau calandre</td><td colspan="3">${MAT_NAMES[R.matShell]}</td></tr>

      <tr class="section-title"><td colspan="4">5. CONDITIONS DE DESIGN</td></tr>
      <tr><td>Pression design calandre</td><td><input value="${fmt(Math.ceil(v('hP')*1.1/0.5)*0.5,1)}"></td><td>Pression design tubes</td><td><input value="${fmt(Math.ceil(v('cP')*1.1/0.5)*0.5,1)}"></td></tr>
      <tr><td colspan="2">bar g</td><td colspan="2">bar g</td></tr>
      <tr><td>Temp. design calandre</td><td><input value="${fmt(Math.ceil((R.Tmax+20)/10)*10,0)}"></td><td>Temp. design tubes</td><td><input value="${fmt(Math.ceil((R.Tmax+20)/10)*10,0)}"></td></tr>
      <tr><td colspan="2">¬∞C</td><td colspan="2">¬∞C</td></tr>

      <tr class="section-title"><td colspan="4">6. CODES & NORMES</td></tr>
      <tr><td>Code de construction</td><td colspan="3"><input value="ASME VIII Div.1 / EN 13445"></td></tr>
      <tr><td>Standard √©changeur</td><td colspan="3"><input value="TEMA R (Refinery) / API 660"></td></tr>
      <tr><td>Directive PED</td><td colspan="3"><input value="2014/68/EU ‚Äî Cat√©gorie III"></td></tr>

      <tr class="section-title"><td colspan="4">7. NOTES</td></tr>
      <tr><td colspan="4"><textarea style="width:100%;min-height:60px;border:1px solid #ccc;padding:.5rem;font-family:DM Sans;font-size:.8rem" placeholder="Notes compl√©mentaires..."></textarea></td></tr>
    </table>
    <div style="text-align:center;margin-top:1rem;font-size:.75rem;color:#999">
      G√©n√©r√© par HeatXAI ‚Äî ${today} ‚Äî Document pour demande de chiffrage fournisseur
    </div>
  </div>`;
}

function printSpec() {
  document.querySelectorAll('.panel').forEach(p => { p.classList.remove('print-target'); });
  document.getElementById('p-datasheet').classList.add('print-target');
  window.print();
}

// ===================== RENDU RAPPORT =====================
function renderReport() {
  document.getElementById('noReport').style.display = 'none';
  document.getElementById('reportContent').style.display = 'block';

  document.getElementById('reportSheet').innerHTML = `
  <div class="spec-sheet" id="reportPrint">
    <h2>RAPPORT TECHNIQUE ‚Äî DIMENSIONNEMENT √âCHANGEUR DE CHALEUR</h2>
    <p style="text-align:center;color:#666;margin-bottom:1.5rem">G√©n√©r√© par HeatXAI ‚Äî ${new Date().toISOString().split('T')[0]}</p>

    <h3 style="color:var(--accD);border-bottom:2px solid var(--acc);padding-bottom:.3rem">1. Objet</h3>
    <p>Ce rapport pr√©sente le dimensionnement pr√©liminaire d'un √©changeur de chaleur pour le service <strong>${R.hf.name} / ${R.cf.name}</strong>.
    L'objectif est de transf√©rer <strong>${fmt(R.Q,1)} kW</strong> du fluide chaud (${R.hf.name}, ${fmt(R.hTin,0)}‚Üí${fmt(R.hTout,0)}¬∞C)
    vers le fluide froid (${R.cf.name}, ${fmt(R.cTin,0)}‚Üí${fmt(R.cTout,0)}¬∞C).</p>

    <h3 style="color:var(--accD);border-bottom:2px solid var(--acc);padding-bottom:.3rem;margin-top:1.5rem">2. Hypoth√®ses de calcul</h3>
    <ul>
      <li>R√©gime permanent, propri√©t√©s physiques √† temp√©rature moyenne</li>
      <li>Configuration : ${R.config === 'counter' ? 'contre-courant' : R.config === 'parallel' ? 'co-courant' : R.config}</li>
      <li>M√©thode DTLM avec facteur de correction F = ${fmt(R.F,3)}</li>
      <li>Corr√©lation c√¥t√© tubes : ${R.Re_tube > 10000 ? 'Dittus-Boelter (turbulent)' : 'Sieder-Tate (transition/laminaire)'}</li>
      <li>Corr√©lation c√¥t√© calandre : ${R.hState==='condensation' ? 'Nusselt (condensation film)' : 'Kern'}</li>
      <li>Facteurs d'encrassement TEMA : chaud ${fmtE(R.foulH)} / froid ${fmtE(R.foulC)} m¬≤¬∑K/W</li>
      <li>Surdesign appliqu√© : +${R.overdesign*100}%</li>
    </ul>

    <h3 style="color:var(--accD);border-bottom:2px solid var(--acc);padding-bottom:.3rem;margin-top:1.5rem">3. R√©sultats principaux</h3>
    <table>
      <tr><th>Param√®tre</th><th>Valeur</th><th>Unit√©</th></tr>
      <tr><td>Puissance thermique Q</td><td>${fmt(R.Q,1)}</td><td>kW</td></tr>
      <tr><td>DTLM corrig√©</td><td>${fmt(R.LMTD_corr,1)}</td><td>¬∞C</td></tr>
      <tr><td>Coefficient global U</td><td>${fmt(R.Uo,0)}</td><td>W/(m¬≤¬∑K)</td></tr>
      <tr><td>Surface d'√©change (design)</td><td>${fmt(R.A_design,1)}</td><td>m¬≤</td></tr>
      <tr><td>Efficacit√© thermique Œµ</td><td>${fmt(R.epsilon*100,1)}</td><td>%</td></tr>
      <tr><td>NTU</td><td>${fmt(R.NTU,2)}</td><td>‚Äî</td></tr>
    </table>

    <h3 style="color:var(--accD);border-bottom:2px solid var(--acc);padding-bottom:.3rem;margin-top:1.5rem">4. √âquipement s√©lectionn√©</h3>
    <p><strong>${R.hxType}</strong> ‚Äî TEMA ${R.temaType}</p>
    <table>
      <tr><td>Diam√®tre calandre</td><td>${fmt(R.Ds,0)} mm</td></tr>
      <tr><td>Nombre de tubes √ó dimensions</td><td>${R.nTubes} √ó √ò${fmt(R.tubeOD,1)}mm √ó ${fmt(R.Ltube*1000,0)}mm</td></tr>
      <tr><td>Passes tubes</td><td>${R.nPasses}</td></tr>
      <tr><td>Mat√©riau tubes / calandre</td><td>${MAT_NAMES[R.matTube]} / ${MAT_NAMES[R.matShell]}</td></tr>
    </table>

    <h3 style="color:var(--accD);border-bottom:2px solid var(--acc);padding-bottom:.3rem;margin-top:1.5rem">5. V√©rifications</h3>
    <table>
      <tr><th>Param√®tre</th><th>Valeur</th><th>Limite</th><th>Statut</th></tr>
      <tr><td>ŒîP tubes</td><td>${fmt(R.dP_tube,1)} kPa</td><td>${v('dPh')} kPa</td><td>${R.dP_tube<=v('dPh')?'‚úÖ OK':'‚ùå NOK'}</td></tr>
      <tr><td>ŒîP calandre</td><td>${fmt(R.dP_shell,1)} kPa</td><td>${v('dPc')} kPa</td><td>${R.dP_shell<=v('dPc')?'‚úÖ OK':'‚ùå NOK'}</td></tr>
      <tr><td>Vitesse tubes</td><td>${fmt(R.vTube,2)} m/s</td><td>0.5‚Äì3.0 m/s</td><td>${R.vTube>=0.5&&R.vTube<=3?'‚úÖ OK':'‚ö†Ô∏è Hors plage'}</td></tr>
      <tr><td>Vitesse calandre</td><td>${fmt(R.vShell,2)} m/s</td><td>0.3‚Äì1.5 m/s</td><td>${R.vShell>=0.3&&R.vShell<=1.5?'‚úÖ OK':'‚ö†Ô∏è Hors plage'}</td></tr>
      <tr><td>R√©gime d'√©coulement</td><td>Re = ${fmt(R.Re_tube,0)}</td><td>> 10 000</td><td>${R.Re_tube>10000?'‚úÖ Turbulent':'‚ö†Ô∏è '+( R.Re_tube>2300?'Transition':'Laminaire')}</td></tr>
    </table>

    <h3 style="color:var(--accD);border-bottom:2px solid var(--acc);padding-bottom:.3rem;margin-top:1.5rem">6. Recommandations</h3>
    <ul>
      ${R.dP_tube > v('dPh') ? '<li>R√©duire le nombre de passes tubes ou augmenter le nombre de tubes pour diminuer ŒîP c√¥t√© tubes.</li>' : ''}
      ${R.dP_shell > v('dPc') ? '<li>Augmenter l\'espacement des chicanes ou le diam√®tre calandre pour diminuer ŒîP c√¥t√© calandre.</li>' : ''}
      ${R.vTube < 0.5 ? '<li>Vitesse tubes faible : risque d\'encrassement. Envisager de r√©duire le nombre de tubes.</li>' : ''}
      ${R.vTube > 3 ? '<li>Vitesse tubes √©lev√©e : risque d\'√©rosion. Augmenter le nombre de tubes.</li>' : ''}
      <li>V√©rifier la compatibilit√© des mat√©riaux avec les fluides process (corrosion).</li>
      <li>Dimensionnement pr√©liminaire ‚Äî confirmer par simulation d√©taill√©e (HTRI/Aspen EDR) avant fabrication.</li>
      <li>Consulter les fournisseurs identifi√©s dans l'onglet Fournisseurs pour chiffrage.</li>
    </ul>

    <div style="text-align:center;margin-top:2rem;padding-top:1rem;border-top:1px solid #ccc;font-size:.75rem;color:#999">
      HeatXAI ‚Äî Rapport de dimensionnement pr√©liminaire ‚Äî ${new Date().toISOString().split('T')[0]}
    </div>
  </div>`;
}

function printReport() {
  document.querySelectorAll('.panel').forEach(p => { p.classList.remove('print-target'); });
  document.getElementById('p-rapport').classList.add('print-target');
  window.print();
}

// ===================== INITIALISATION =====================
initFluids();
</script>
</body>
</html>
