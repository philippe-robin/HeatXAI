<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>HeatXAI ‚Äî Conception d'√âchangeurs de Chaleur</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üî•</text></svg>">
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600;700&family=Space+Mono:wght@400;700&family=Playfair+Display:wght@700;900&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<style>
:root{--bg:#0a0e1a;--bg2:#111827;--card:#1a2035;--inp:#0d1220;--acc:#f59e0b;--accL:#fbbf24;--accD:#d97706;--t1:#f1f5f9;--t2:#94a3b8;--t3:#64748b;--brd:#1e293b;--ok:#10b981;--warn:#f59e0b;--err:#ef4444;--info:#3b82f6}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--t1);min-height:100vh}
body::before{content:'';position:fixed;inset:0;background:radial-gradient(ellipse at 20% 0%,rgba(245,158,11,.08)0%,transparent 50%),radial-gradient(ellipse at 80% 100%,rgba(59,130,246,.05)0%,transparent 50%);pointer-events:none;z-index:0}
.header{position:sticky;top:0;z-index:100;background:rgba(10,14,26,.92);backdrop-filter:blur(20px);border-bottom:1px solid var(--brd);padding:.8rem 2rem;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:.5rem}
.logo{display:flex;align-items:center;gap:.6rem}
.logo-icon{width:38px;height:38px;background:linear-gradient(135deg,var(--acc),var(--accD));border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:1.1rem}
.logo-text{font-family:'Playfair Display',serif;font-size:1.4rem;font-weight:900;background:linear-gradient(135deg,var(--accL),var(--acc));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.logo-sub{font-size:.65rem;color:var(--t3);letter-spacing:2px;text-transform:uppercase}
.nav-tabs{display:flex;gap:2px;background:var(--bg2);border-radius:12px;padding:3px;overflow-x:auto}
.nav-tab{padding:.55rem 1rem;border:none;background:none;color:var(--t2);cursor:pointer;border-radius:10px;font-family:'DM Sans',sans-serif;font-size:.82rem;font-weight:500;transition:all .3s;white-space:nowrap}
.nav-tab:hover{color:var(--t1)}.nav-tab.active{background:var(--acc);color:var(--bg);font-weight:600}
.main{position:relative;z-index:1;max-width:1600px;margin:0 auto;padding:1.5rem 2rem}
.panel{display:none;animation:fadeIn .35s ease}.panel.active{display:block}
@keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
.card{background:var(--card);border:1px solid var(--brd);border-radius:14px;padding:1.4rem;margin-bottom:1.4rem;box-shadow:0 4px 20px rgba(0,0,0,.25)}
.card-title{font-family:'Playfair Display',serif;font-size:1.15rem;font-weight:700;margin-bottom:1rem;display:flex;align-items:center;gap:.5rem}
.fg{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:1rem}
.fg label{font-size:.78rem;color:var(--t2);font-weight:500;text-transform:uppercase;letter-spacing:.4px}
.fg input,.fg select,.fg textarea{padding:.65rem .9rem;background:var(--inp);border:1px solid var(--brd);border-radius:9px;color:var(--t1);font-family:'Space Mono',monospace;font-size:.88rem;transition:border-color .3s;width:100%}
.fg input:focus,.fg select:focus,.fg textarea:focus{outline:none;border-color:var(--acc);box-shadow:0 0 0 3px rgba(245,158,11,.15)}
.fg select option{background:var(--bg2);color:var(--t1)}
.fg .unit{font-size:.72rem;color:var(--t3);font-family:'Space Mono',monospace}
.fg>div{display:flex;flex-direction:column;gap:.3rem}
.fg input:disabled,.fg select:disabled{opacity:.4;cursor:not-allowed}
.btn{padding:.75rem 1.8rem;border:none;border-radius:11px;font-family:'DM Sans',sans-serif;font-weight:600;font-size:.92rem;cursor:pointer;transition:all .3s;display:inline-flex;align-items:center;gap:.4rem}
.btn-p{background:linear-gradient(135deg,var(--acc),var(--accD));color:var(--bg)}
.btn-p:hover{transform:translateY(-2px);box-shadow:0 8px 24px rgba(245,158,11,.3)}
.btn-s{background:var(--bg2);color:var(--t1);border:1px solid var(--brd)}
.btn-s:hover{border-color:var(--acc)}
.btn-group{display:flex;gap:.7rem;margin-top:1.4rem;flex-wrap:wrap}
.rg{display:grid;grid-template-columns:repeat(auto-fit,minmax(170px,1fr));gap:.8rem}
.ri{background:var(--inp);border:1px solid var(--brd);border-radius:11px;padding:1rem;text-align:center}
.rv{font-family:'Space Mono',monospace;font-size:1.5rem;font-weight:700;color:var(--acc);line-height:1.2}
.rl{font-size:.72rem;color:var(--t2);margin-top:.25rem;text-transform:uppercase;letter-spacing:.4px}
.ru{font-size:.8rem;color:var(--t3);font-family:'Space Mono',monospace}
.two{display:grid;grid-template-columns:1fr 1fr;gap:1.4rem}
@media(max-width:900px){.two{grid-template-columns:1fr}.header{flex-direction:column}.nav-tabs{flex-wrap:wrap}}
.chart-c{position:relative;height:340px;margin:.8rem 0}
.wb{background:rgba(245,158,11,.1);border:1px solid var(--acc);border-radius:10px;padding:1rem;font-size:.85rem;color:var(--accL);margin:1rem 0}
.ib{background:rgba(59,130,246,.1);border:1px solid var(--info);border-radius:10px;padding:1rem;font-size:.85rem;color:#93c5fd;margin:1rem 0}
.eb{background:rgba(239,68,68,.1);border:1px solid var(--err);border-radius:10px;padding:1rem;font-size:.85rem;color:#fca5a5;margin:1rem 0}
.okb{background:rgba(16,185,129,.1);border:1px solid var(--ok);border-radius:10px;padding:1rem;font-size:.85rem;color:#6ee7b7;margin:1rem 0}
.rt{width:100%;border-collapse:collapse;margin:.8rem 0;font-size:.88rem}
.rt th,.rt td{padding:.55rem .9rem;text-align:left;border-bottom:1px solid var(--brd)}
.rt th{color:var(--acc);font-weight:600;text-transform:uppercase;font-size:.73rem;letter-spacing:.4px}
.tag{display:inline-block;padding:.15rem .5rem;border-radius:5px;font-size:.7rem;font-weight:600;margin-left:.4rem}
.tag-st{background:rgba(59,130,246,.2);color:#93c5fd}
.tag-phe{background:rgba(16,185,129,.2);color:#6ee7b7}
.tag-sp{background:rgba(239,68,68,.2);color:#fca5a5}
.tag-ac{background:rgba(245,158,11,.2);color:#fbbf24}
.loading{display:none;position:fixed;inset:0;background:rgba(10,14,26,.88);z-index:1000;justify-content:center;align-items:center;flex-direction:column;gap:1.2rem}
.loading.show{display:flex}
.spinner{width:55px;height:55px;border:3px solid var(--brd);border-top-color:var(--acc);border-radius:50%;animation:spin 1s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.lt{font-size:1rem;color:var(--acc);text-align:center}
.phase-fields{display:none}.phase-fields.show{display:grid}
.mode-switch{display:flex;gap:2px;background:var(--bg2);border-radius:10px;padding:3px;margin-bottom:1rem}
.mode-btn{flex:1;padding:.5rem .8rem;border:none;background:none;color:var(--t2);cursor:pointer;border-radius:8px;font-family:'DM Sans',sans-serif;font-size:.82rem;font-weight:500;transition:all .3s;text-align:center}
.mode-btn.active{background:var(--acc);color:var(--bg);font-weight:600}
.supplier-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:1rem}
.supplier-card{background:var(--inp);border:1px solid var(--brd);border-radius:11px;padding:1.2rem;transition:border-color .3s}
.supplier-card:hover{border-color:var(--acc)}
.supplier-card h4{color:var(--acc);margin-bottom:.3rem}
.supplier-card .country{font-size:.78rem;color:var(--t3)}
.supplier-card .spec{font-size:.85rem;color:var(--t2);margin:.4rem 0}
.supplier-card a{color:var(--accL);text-decoration:none;font-size:.82rem}
.supplier-card a:hover{text-decoration:underline}
.spec-sheet{background:#fff;color:#111;border-radius:11px;padding:2rem;font-family:'DM Sans',sans-serif;font-size:.85rem}
.spec-sheet h2{text-align:center;margin-bottom:1rem;font-size:1.2rem}
.spec-sheet table{width:100%;border-collapse:collapse;margin:.8rem 0}
.spec-sheet th,.spec-sheet td{border:1px solid #ccc;padding:.4rem .6rem;font-size:.8rem}
.spec-sheet th{background:#f0f0f0;font-weight:600}
.spec-sheet .section-title{background:var(--acc);color:#fff;font-weight:700;text-align:center}
.spec-sheet input{border:none;border-bottom:1px dashed #999;width:100%;font-family:'DM Sans',sans-serif;font-size:.8rem;padding:.2rem;background:transparent}
.spec-sheet input:focus{outline:none;border-bottom-color:var(--acc)}
.props-preview{background:var(--inp);border:1px solid var(--brd);border-radius:9px;padding:.8rem;margin-top:.8rem;font-size:.82rem}
.props-preview table{width:100%;font-size:.78rem}.props-preview td{padding:.2rem .5rem;color:var(--t2)}
.props-preview td:first-child{color:var(--t3);width:50%}
.props-preview td:last-child{color:var(--accL);font-family:'Space Mono',monospace}
::-webkit-scrollbar{width:5px}::-webkit-scrollbar-track{background:var(--bg)}::-webkit-scrollbar-thumb{background:var(--brd);border-radius:3px}
@media print{
  .header,.nav-tabs,.btn-group,.no-print{display:none!important}
  .panel{display:block!important}
  .panel:not(.print-target){display:none!important}
  .spec-sheet{box-shadow:none;border-radius:0}
  body{background:#fff;color:#111}
}
</style>
</head>
<body>
<div class="loading" id="ld"><div class="spinner"></div><div class="lt" id="ldT">Calculs en cours...</div></div>

<header class="header">
<div class="logo">
  <div class="logo-icon">üî•</div>
  <div><div class="logo-text">HeatXAI</div><div class="logo-sub">Conception d'√©changeurs de chaleur</div></div>
</div>
<nav class="nav-tabs">
  <button class="nav-tab active" onclick="sp('saisie')">Saisie</button>
  <button class="nav-tab" onclick="sp('resultats')">R√©sultats</button>
  <button class="nav-tab" onclick="sp('geometrie')">G√©om√©trie</button>
  <button class="nav-tab" onclick="sp('courbes')">Courbes</button>
  <button class="nav-tab" onclick="sp('fournisseurs')">Fournisseurs</button>
  <button class="nav-tab" onclick="sp('datasheet')">Fiche Spec</button>
  <button class="nav-tab" onclick="sp('rapport')">Rapport</button>
</nav>
</header>

<main class="main">

<!-- ==================== ONGLET 1 : SAISIE ==================== -->
<div class="panel active" id="p-saisie">

<!-- MODE DE CALCUL -->
<div class="card">
  <div class="card-title">üéØ Mode de calcul</div>
  <div class="mode-switch">
    <button class="mode-btn active" id="modeTarget" onclick="setMode('target')">Temp√©rature cible du process</button>
    <button class="mode-btn" id="modeQ" onclick="setMode('duty')">Puissance thermique Q impos√©e</button>
  </div>
  <div class="fg">
    <div><label>Op√©ration</label><select id="operation">
      <option value="cooling">Refroidissement (process chaud ‚Üí utilit√© froide)</option>
      <option value="heating">Chauffage (process froid ‚Üí utilit√© chaude)</option>
    </select></div>
    <div id="divTarget"><label>Temp√©rature cible process</label><input type="number" id="procTout" step="any" placeholder="¬∞C"><span class="unit">¬∞C</span></div>
    <div id="divDuty" style="display:none"><label>Puissance thermique Q</label><input type="number" id="imposedQ" step="any" placeholder="kW"><span class="unit">kW</span></div>
  </div>
</div>

<div class="two">

<!-- FLUIDE PROCESS -->
<div class="card">
  <div class="card-title">‚öôÔ∏è Fluide Process</div>
  <div class="fg">
    <div><label>Fluide</label><select id="procFluid" onchange="onFluidChange('proc')">
      <option value="">‚Äî S√©lectionner ‚Äî</option>
      <option value="custom">‚úèÔ∏è Saisie manuelle</option>
    </select></div>
    <div><label>D√©bit massique</label><input type="number" id="procFlow" step="any" placeholder="0"><span class="unit">kg/h</span></div>
    <div><label>Temp√©rature entr√©e</label><input type="number" id="procTin" step="any" placeholder="¬∞C"><span class="unit">¬∞C</span></div>
    <div><label>Pression service</label><input type="number" id="procP" step="any" value="3"><span class="unit">bar abs</span></div>
    <div><label>√âtat</label><select id="procState" onchange="onStateChange('proc')">
      <option value="liquid">Liquide</option>
      <option value="gas">Gaz</option>
      <option value="condensation">Condensation</option>
      <option value="evaporation">√âvaporation</option>
    </select></div>
  </div>
  <div class="phase-fields fg" id="procPhase" style="margin-top:.8rem">
    <div><label>Titre vapeur entr√©e</label><input type="number" id="procXin" step="0.01" value="1" min="0" max="1"><span class="unit">0-1</span></div>
    <div><label>Titre vapeur sortie</label><input type="number" id="procXout" step="0.01" value="0" min="0" max="1"><span class="unit">0-1</span></div>
    <div><label>Chaleur latente</label><input type="number" id="procLat" step="any" placeholder="auto"><span class="unit">kJ/kg</span></div>
  </div>
  <div class="fg" id="procManual" style="display:none;margin-top:.8rem">
    <div><label>œÅ (masse vol.)</label><input type="number" id="procRho" step="any"><span class="unit">kg/m¬≥</span></div>
    <div><label>Œº (viscosit√©)</label><input type="number" id="procMu" step="any"><span class="unit">mPa¬∑s</span></div>
    <div><label>Cp</label><input type="number" id="procCp" step="any"><span class="unit">kJ/(kg¬∑K)</span></div>
    <div><label>Œª (conductivit√©)</label><input type="number" id="procLambda" step="any"><span class="unit">W/(m¬∑K)</span></div>
  </div>
  <div class="props-preview" id="procProps"></div>
</div>

<!-- FLUIDE UTILIT√â -->
<div class="card">
  <div class="card-title">üíß Fluide Utilit√©</div>
  <div class="ib" style="margin-bottom:1rem;margin-top:0">Le d√©bit et la temp√©rature de sortie de l'utilit√© seront <strong>calcul√©s automatiquement</strong>.</div>
  <div class="fg">
    <div><label>Fluide utilit√©</label><select id="utilFluid" onchange="onFluidChange('util')">
      <option value="">‚Äî S√©lectionner ‚Äî</option>
      <option value="custom">‚úèÔ∏è Saisie manuelle</option>
    </select></div>
    <div><label>Temp√©rature entr√©e</label><input type="number" id="utilTin" step="any" placeholder="¬∞C"><span class="unit">¬∞C</span></div>
    <div><label>Pression service</label><input type="number" id="utilP" step="any" value="3"><span class="unit">bar abs</span></div>
    <div><label>√âtat</label><select id="utilState" onchange="onStateChange('util')">
      <option value="liquid">Liquide</option>
      <option value="gas">Gaz</option>
      <option value="condensation">Condensation (vapeur ‚Üí liquide)</option>
      <option value="evaporation">√âvaporation</option>
    </select></div>
    <div><label>ŒîT sortie utilit√© (approche)</label><input type="number" id="utilApproach" step="any" value="15"><span class="unit">¬∞C (ŒîT max admis)</span></div>
  </div>
  <div class="phase-fields fg" id="utilPhase" style="margin-top:.8rem">
    <div><label>Titre vapeur entr√©e</label><input type="number" id="utilXin" step="0.01" value="1" min="0" max="1"><span class="unit">0-1</span></div>
    <div><label>Titre vapeur sortie</label><input type="number" id="utilXout" step="0.01" value="0" min="0" max="1"><span class="unit">0-1</span></div>
    <div><label>Chaleur latente</label><input type="number" id="utilLat" step="any" placeholder="auto"><span class="unit">kJ/kg</span></div>
  </div>
  <div class="fg" id="utilManual" style="display:none;margin-top:.8rem">
    <div><label>œÅ</label><input type="number" id="utilRho" step="any"><span class="unit">kg/m¬≥</span></div>
    <div><label>Œº</label><input type="number" id="utilMu" step="any"><span class="unit">mPa¬∑s</span></div>
    <div><label>Cp</label><input type="number" id="utilCp" step="any"><span class="unit">kJ/(kg¬∑K)</span></div>
    <div><label>Œª</label><input type="number" id="utilLambda" step="any"><span class="unit">W/(m¬∑K)</span></div>
  </div>
  <div class="props-preview" id="utilProps"></div>
</div>

</div>

<!-- PARAM√àTRES DE CONCEPTION -->
<div class="card">
  <div class="card-title">üîß Param√®tres de conception</div>
  <div class="fg">
    <div><label>ŒîP max c√¥t√© process</label><input type="number" id="dPproc" step="any" value="50"><span class="unit">kPa</span></div>
    <div><label>ŒîP max c√¥t√© utilit√©</label><input type="number" id="dPutil" step="any" value="50"><span class="unit">kPa</span></div>
    <div><label>Fouling c√¥t√© process</label><input type="number" id="foulProc" step="0.00001" value="0.00018"><span class="unit">m¬≤¬∑K/W</span></div>
    <div><label>Fouling c√¥t√© utilit√©</label><input type="number" id="foulUtil" step="0.00001" value="0.00018"><span class="unit">m¬≤¬∑K/W</span></div>
    <div><label>Surdesign</label><input type="number" id="overdesign" step="1" value="15"><span class="unit">%</span></div>
    <div><label>Mat√©riau tubes</label><select id="matTube">
      <option value="cs">Acier carbone</option>
      <option value="ss304">Inox 304</option>
      <option value="ss316" selected>Inox 316L</option>
      <option value="ti">Titane</option>
      <option value="cu">Cuivre</option>
      <option value="cuni">Cupro-nickel 90/10</option>
      <option value="hast">Hastelloy C-276</option>
    </select></div>
    <div><label>Mat√©riau calandre</label><select id="matShell">
      <option value="cs" selected>Acier carbone</option>
      <option value="ss304">Inox 304</option>
      <option value="ss316">Inox 316L</option>
      <option value="ti">Titane</option>
      <option value="hast">Hastelloy C-276</option>
    </select></div>
    <div><label>Configuration</label><select id="flowConfig">
      <option value="counter">Contre-courant</option>
      <option value="parallel">Co-courant</option>
      <option value="crossflow">Courants crois√©s</option>
      <option value="shell12" selected>Calandre 1-2 passes</option>
      <option value="shell24">Calandre 2-4 passes</option>
    </select></div>
  </div>
</div>

<div class="btn-group">
  <button class="btn btn-p" onclick="calculate()">‚ö° Calculer le dimensionnement</button>
  <button class="btn btn-s" onclick="resetForm()">üîÑ R√©initialiser</button>
  <button class="btn btn-s" onclick="loadExample('cooling')">üìã Exemple refroidissement eau/eau</button>
  <button class="btn btn-s" onclick="loadExample('heating')">üìã Exemple chauffage vapeur/eau</button>
</div>
</div>

<!-- ==================== ONGLET 2 : R√âSULTATS ==================== -->
<div class="panel" id="p-resultats">
<div id="noResults" class="ib">Lancez un calcul depuis l'onglet Saisie pour voir les r√©sultats.</div>
<div id="resultsContent" style="display:none">
<div class="card"><div class="card-title">‚ö° Bilan Thermique</div><div class="rg" id="rgThermal"></div></div>
<div class="card"><div class="card-title">üíß C√¥t√© Utilit√© ‚Äî R√©sultats calcul√©s</div><div class="rg" id="rgUtility"></div></div>
<div class="card"><div class="card-title">üè∑Ô∏è Type d'√©changeur recommand√©</div><div id="hxTypeRecommendation"></div></div>
<div class="card"><div class="card-title">üìê Dimensionnement pr√©liminaire</div><div class="rg" id="rgSizing"></div></div>
<div class="card"><div class="card-title">üíß V√©rification hydraulique</div><div class="rg" id="rgHydraulic"></div><div id="hydraulicAlerts"></div></div>
<div class="card"><div class="card-title">üî¨ Coefficients de transfert</div><div class="rg" id="rgCoeff"></div></div>
</div>
</div>

<!-- ==================== ONGLET 3 : G√âOM√âTRIE ==================== -->
<div class="panel" id="p-geometrie">
<div id="noGeom" class="ib">Lancez un calcul pour voir la g√©om√©trie d√©taill√©e.</div>
<div id="geomContent" style="display:none">
<div class="two">
  <div class="card"><div class="card-title">üîß Param√®tres g√©om√©triques</div><div id="geomParams"></div></div>
  <div class="card"><div class="card-title">üìä Sch√©ma de l'√©changeur</div><div id="geomSVG"></div></div>
</div>
<div class="card"><div class="card-title">üìã Nomenclature TEMA</div><div id="temaRef"></div></div>
</div>
</div>

<!-- ==================== ONGLET 4 : COURBES ==================== -->
<div class="panel" id="p-courbes">
<div id="noCurves" class="ib">Lancez un calcul pour voir les courbes de performance.</div>
<div id="curvesContent" style="display:none">
<div class="two">
  <div class="card"><div class="card-title">üå°Ô∏è Profil de temp√©rature</div><div class="chart-c"><canvas id="chartTemp"></canvas></div></div>
  <div class="card"><div class="card-title">üìà Efficacit√© Œµ vs NTU</div><div class="chart-c"><canvas id="chartNTU"></canvas></div></div>
</div>
<div class="two">
  <div class="card"><div class="card-title">üíß ŒîP vs D√©bit</div><div class="chart-c"><canvas id="chartDP"></canvas></div></div>
  <div class="card"><div class="card-title">üîÑ U vs D√©bit</div><div class="chart-c"><canvas id="chartU"></canvas></div></div>
</div>
<div class="card"><div class="card-title">üìä Diagramme Q-T (Courbes composites)</div><div class="chart-c"><canvas id="chartQT"></canvas></div></div>
</div>
</div>

<!-- ==================== ONGLET 5 : FOURNISSEURS ==================== -->
<div class="panel" id="p-fournisseurs">
<div class="card"><div class="card-title">üè≠ Fournisseurs d'√©changeurs de chaleur</div>
<div class="ib" id="supplierFilter">Lancez un calcul pour filtrer par type d'√©changeur recommand√©.</div>
<div class="supplier-grid" id="supplierGrid"></div>
</div>
</div>

<!-- ==================== ONGLET 6 : FICHE SPEC ==================== -->
<div class="panel" id="p-datasheet">
<div id="noSpec" class="ib">Lancez un calcul pour g√©n√©rer la fiche de sp√©cification.</div>
<div id="specContent" style="display:none">
  <div class="btn-group no-print" style="margin-bottom:1rem"><button class="btn btn-p" onclick="printSpec()">üñ®Ô∏è Imprimer / Export PDF</button></div>
  <div id="specSheet"></div>
</div>
</div>

<!-- ==================== ONGLET 7 : RAPPORT ==================== -->
<div class="panel" id="p-rapport">
<div id="noReport" class="ib">Lancez un calcul pour g√©n√©rer le rapport technique.</div>
<div id="reportContent" style="display:none">
  <div class="btn-group no-print" style="margin-bottom:1rem"><button class="btn btn-p" onclick="printReport()">üñ®Ô∏è Imprimer le rapport</button></div>
  <div id="reportSheet"></div>
</div>
</div>

</main>

<script>
/* ====================================================================
   HeatXAI v2 ‚Äî Moteur de calcul d'√©changeurs de chaleur
   Approche ing√©nieur : entr√©es = fluides + T entr√©e + d√©bit process
   ==================================================================== */

// ===================== BASE DE DONN√âES FLUIDES =====================
const FLUIDS={
  "water":{name:"Eau",rho:995,mu:0.8,cp:4.18,lam:0.62,pr:5.4,lat:2257,tsat:100,cat:"liquid"},
  "steam_lp":{name:"Vapeur BP (3 bar)",rho:1.65,mu:0.012,cp:2.08,lam:0.027,pr:0.96,lat:2164,tsat:133.5,cat:"gas"},
  "steam_mp":{name:"Vapeur MP (10 bar)",rho:5.15,mu:0.014,cp:2.21,lam:0.033,pr:0.95,lat:2015,tsat:179.9,cat:"gas"},
  "steam_hp":{name:"Vapeur HP (40 bar)",rho:20.1,mu:0.017,cp:2.68,lam:0.047,pr:0.97,lat:1714,tsat:250.4,cat:"gas"},
  "cw":{name:"Eau de refroidissement (CW)",rho:998,mu:0.9,cp:4.18,lam:0.61,pr:6.2,lat:0,cat:"liquid"},
  "chw":{name:"Eau glac√©e (7¬∞C)",rho:1000,mu:1.3,cp:4.19,lam:0.57,pr:9.5,lat:0,cat:"liquid"},
  "air":{name:"Air",rho:1.18,mu:0.0185,cp:1.006,lam:0.026,pr:0.71,lat:0,cat:"gas"},
  "nitrogen":{name:"Azote",rho:1.15,mu:0.0178,cp:1.04,lam:0.026,pr:0.71,lat:199,tsat:-196,cat:"gas"},
  "therminol55":{name:"Therminol 55",rho:868,mu:3.5,cp:1.88,lam:0.12,pr:55,lat:0,cat:"liquid"},
  "therminol66":{name:"Therminol 66",rho:998,mu:6.0,cp:1.56,lam:0.118,pr:80,lat:0,cat:"liquid"},
  "dowtherm_a":{name:"Dowtherm A",rho:1056,mu:3.7,cp:1.55,lam:0.14,pr:41,lat:0,cat:"liquid"},
  "glycol30":{name:"Glycol EG 30%",rho:1038,mu:2.5,cp:3.56,lam:0.46,pr:19.4,lat:0,cat:"liquid"},
  "glycol50":{name:"Glycol EG 50%",rho:1070,mu:4.0,cp:3.14,lam:0.38,pr:33,lat:0,cat:"liquid"},
  "methanol":{name:"M√©thanol",rho:791,mu:0.55,cp:2.53,lam:0.20,pr:6.9,lat:1100,tsat:64.7,cat:"liquid"},
  "ethanol":{name:"√âthanol",rho:789,mu:1.07,cp:2.44,lam:0.17,pr:15.4,lat:846,tsat:78.4,cat:"liquid"},
  "acetone":{name:"Ac√©tone",rho:784,mu:0.31,cp:2.16,lam:0.16,pr:4.2,lat:539,tsat:56.2,cat:"liquid"},
  "toluene":{name:"Tolu√®ne",rho:867,mu:0.56,cp:1.70,lam:0.13,pr:7.3,lat:351,tsat:110.6,cat:"liquid"},
  "hexane":{name:"Hexane",rho:655,mu:0.30,cp:2.27,lam:0.12,pr:5.7,lat:335,tsat:68.7,cat:"liquid"},
  "heptane":{name:"Heptane",rho:684,mu:0.39,cp:2.25,lam:0.12,pr:7.3,lat:318,tsat:98.4,cat:"liquid"},
  "ammonia":{name:"Ammoniac",rho:602,mu:0.13,cp:4.74,lam:0.49,pr:1.3,lat:1370,tsat:-33.3,cat:"liquid"},
  "r134a":{name:"R-134a",rho:1206,mu:0.20,cp:1.43,lam:0.082,pr:3.5,lat:217,tsat:-26.1,cat:"liquid"},
  "r410a":{name:"R-410A",rho:1062,mu:0.15,cp:1.84,lam:0.088,pr:3.1,lat:221,tsat:-51.4,cat:"liquid"},
  "propane":{name:"Propane",rho:493,mu:0.10,cp:2.52,lam:0.096,pr:2.6,lat:426,tsat:-42.1,cat:"liquid"},
  "fuel_light":{name:"Fuel l√©ger",rho:850,mu:3.0,cp:2.05,lam:0.13,pr:47,lat:0,cat:"liquid"},
  "fuel_heavy":{name:"Fuel lourd",rho:950,mu:50,cp:1.88,lam:0.12,pr:785,lat:0,cat:"liquid"},
  "crude_oil":{name:"P√©trole brut",rho:870,mu:8.0,cp:2.05,lam:0.13,pr:126,lat:0,cat:"liquid"},
  "kerosene":{name:"K√©ros√®ne",rho:810,mu:1.6,cp:2.01,lam:0.145,pr:22,lat:0,cat:"liquid"},
  "naphtha":{name:"Naphta",rho:730,mu:0.5,cp:2.14,lam:0.13,pr:8.2,lat:0,cat:"liquid"},
  "h2so4_98":{name:"H‚ÇÇSO‚ÇÑ 98%",rho:1830,mu:25,cp:1.38,lam:0.36,pr:96,lat:0,cat:"liquid"},
  "h2so4_70":{name:"H‚ÇÇSO‚ÇÑ 70%",rho:1615,mu:8.0,cp:1.63,lam:0.43,pr:30,lat:0,cat:"liquid"},
  "naoh_50":{name:"NaOH 50%",rho:1525,mu:12,cp:2.56,lam:0.55,pr:56,lat:0,cat:"liquid"},
  "naoh_30":{name:"NaOH 30%",rho:1330,mu:4.5,cp:3.01,lam:0.58,pr:23,lat:0,cat:"liquid"},
  "hcl_30":{name:"HCl 30%",rho:1149,mu:1.7,cp:2.73,lam:0.45,pr:10.3,lat:0,cat:"liquid"},
  "brine":{name:"Saumure NaCl 20%",rho:1148,mu:1.6,cp:3.33,lam:0.54,pr:9.9,lat:0,cat:"liquid"},
  "seawater":{name:"Eau de mer",rho:1025,mu:1.08,cp:3.99,lam:0.6,pr:7.2,lat:0,cat:"liquid"},
  "mineral_oil":{name:"Huile min√©rale",rho:870,mu:20,cp:1.88,lam:0.13,pr:290,lat:0,cat:"liquid"},
  "olive_oil":{name:"Huile v√©g√©tale",rho:910,mu:65,cp:1.97,lam:0.17,pr:753,lat:0,cat:"liquid"},
  "milk":{name:"Lait",rho:1030,mu:2.0,cp:3.93,lam:0.55,pr:14.3,lat:0,cat:"liquid"},
  "juice":{name:"Jus de fruit",rho:1050,mu:1.5,cp:3.85,lam:0.55,pr:10.5,lat:0,cat:"liquid"},
  "beer":{name:"Bi√®re",rho:1010,mu:1.4,cp:4.05,lam:0.58,pr:9.8,lat:0,cat:"liquid"},
};

const MAT_COND={cs:50,ss304:16.3,ss316:16.3,ti:21.9,cu:386,cuni:29,hast:11.1};
const MAT_NAMES={cs:"Acier carbone",ss304:"Inox 304",ss316:"Inox 316L",ti:"Titane",cu:"Cuivre",cuni:"Cupro-nickel 90/10",hast:"Hastelloy C-276"};

const U_TABLE={
  "liquid-liquid":{low:300,mid:800,high:1500,typical:800},
  "liquid-gas":{low:15,mid:60,high:150,typical:60},
  "gas-gas":{low:5,mid:25,high:50,typical:25},
  "condensation-liquid":{low:500,mid:1500,high:4000,typical:1500},
  "condensation-gas":{low:15,mid:50,high:150,typical:50},
  "liquid-evaporation":{low:300,mid:1000,high:3000,typical:1000},
  "condensation-evaporation":{low:500,mid:1500,high:3000,typical:1500},
};

const FOULING_DEF={
  "water":0.00018,"cw":0.00018,"chw":0.00009,"steam_lp":0.00009,"steam_mp":0.00009,"steam_hp":0.00009,
  "air":0.00035,"nitrogen":0.00018,"therminol55":0.00018,"therminol66":0.00018,"dowtherm_a":0.00018,
  "glycol30":0.00035,"glycol50":0.00035,"methanol":0.00018,"ethanol":0.00018,"acetone":0.00009,
  "fuel_light":0.00035,"fuel_heavy":0.00088,"crude_oil":0.00053,"h2so4_98":0.00035,"naoh_50":0.00035,
  "seawater":0.00035,"mineral_oil":0.00053,"olive_oil":0.00053,"milk":0.00035,
};

// Approche ŒîT typique pour les utilit√©s
const UTIL_APPROACH={
  "cw":15,"chw":5,"water":15,"steam_lp":0,"steam_mp":0,"steam_hp":0,
  "air":30,"therminol55":20,"therminol66":20,"dowtherm_a":20,"glycol30":10,"glycol50":10
};

const SUPPLIERS=[
  {name:"Alfa Laval",country:"Su√®de",types:["phe","spiral","st","welded"],spec:"Leader mondial plaques & spirales",url:"https://www.alfalaval.com",logo:"üá∏üá™"},
  {name:"Kelvion",country:"Allemagne",types:["phe","st","ac","finned"],spec:"Tous types, expertise industrielle",url:"https://www.kelvion.com",logo:"üá©üá™"},
  {name:"SWEP",country:"Su√®de",types:["bphe"],spec:"Plaques bras√©es (HVAC-R, process)",url:"https://www.swep.net",logo:"üá∏üá™"},
  {name:"Tranter",country:"USA",types:["phe","shellplate"],spec:"Plaques joint√©es, shell & plate",url:"https://www.tranter.com",logo:"üá∫üá∏"},
  {name:"API Heat Transfer",country:"USA",types:["st","phe","ac"],spec:"Tous types depuis 1879",url:"https://www.apiheattransfer.com",logo:"üá∫üá∏"},
  {name:"Funke",country:"Allemagne",types:["phe","st"],spec:"Plaques et tubes (groupe HYDAC)",url:"https://www.funke.de",logo:"üá©üá™"},
  {name:"Danfoss (Sondex)",country:"Danemark",types:["phe","bphe"],spec:"Plaques traditionnelles et bras√©es",url:"https://heatexchangers.danfoss.com",logo:"üá©üá∞"},
  {name:"HRS Heat Exchangers",country:"UK",types:["st","scraped","corrugated"],spec:"Tubes, racl√©s, fluides visqueux",url:"https://www.hrs-heatexchangers.com",logo:"üá¨üáß"},
  {name:"Barriquand",country:"France",types:["welded","phe","st","bphe"],spec:"Platular¬Æ (plaques soud√©es), tous types",url:"https://www.barriquand.com",logo:"üá´üá∑"},
  {name:"Onda",country:"Italie",types:["bphe","st","ac"],spec:"Plaques bras√©es, a√©ror√©frig√©rants",url:"https://www.onda-it.com",logo:"üáÆüáπ"},
  {name:"Mersen",country:"France",types:["graphite","corrosion"],spec:"Graphite, milieux tr√®s corrosifs",url:"https://www.mersen.com",logo:"üá´üá∑"},
  {name:"Labbe",country:"France",types:["st","custom"],spec:"Inox sur mesure, √©quipements proc√©d√©s",url:"https://www.labbe.fr",logo:"üá´üá∑"},
  {name:"Vahterus",country:"Finlande",types:["pshe"],spec:"Plate & shell (haute pression/temp)",url:"https://www.vahterus.com",logo:"üá´üáÆ"},
  {name:"Hisaka Works",country:"Japon",types:["phe","bphe"],spec:"Plaques, innovation japonaise",url:"https://www.hisaka.co.jp/english",logo:"üáØüáµ"},
  {name:"Thermofin",country:"Canada",types:["ac","finned"],spec:"A√©ror√©frig√©rants, tubes ailet√©s",url:"https://www.thermofin.com",logo:"üá®üá¶"},
];

let R={};
let charts={};
let calcMode='target'; // 'target' ou 'duty'

// ===================== NAVIGATION =====================
function sp(id){
  document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.nav-tab').forEach(t=>t.classList.remove('active'));
  document.getElementById('p-'+id).classList.add('active');
  const names=['saisie','resultats','geometrie','courbes','fournisseurs','datasheet','rapport'];
  const idx=names.indexOf(id);
  if(idx>=0)document.querySelectorAll('.nav-tab')[idx].classList.add('active');
}

// ===================== MODE =====================
function setMode(m){
  calcMode=m;
  document.getElementById('modeTarget').classList.toggle('active',m==='target');
  document.getElementById('modeQ').classList.toggle('active',m==='duty');
  document.getElementById('divTarget').style.display=m==='target'?'':'none';
  document.getElementById('divDuty').style.display=m==='duty'?'':'none';
}

// ===================== FLUIDES =====================
function initFluids(){
  ['procFluid','utilFluid'].forEach(selId=>{
    const sel=document.getElementById(selId);
    const groups={
      'Utilit√©s':['water','cw','chw','steam_lp','steam_mp','steam_hp','air'],
      'Fluides caloporteurs':['therminol55','therminol66','dowtherm_a','glycol30','glycol50'],
      'Solvants & organiques':['methanol','ethanol','acetone','toluene','hexane','heptane'],
      'R√©frig√©rants':['ammonia','r134a','r410a','propane'],
      'Hydrocarbures':['fuel_light','fuel_heavy','crude_oil','kerosene','naphtha'],
      'Acides & bases':['h2so4_98','h2so4_70','naoh_50','naoh_30','hcl_30'],
      'Autres':['brine','seawater','nitrogen','mineral_oil','olive_oil','milk','juice','beer'],
    };
    Object.entries(groups).forEach(([gName,keys])=>{
      const og=document.createElement('optgroup');
      og.label=gName;
      keys.forEach(k=>{
        if(!FLUIDS[k])return;
        const o=document.createElement('option');
        o.value=k;o.textContent=FLUIDS[k].name;
        og.appendChild(o);
      });
      sel.appendChild(og);
    });
  });
}

function onFluidChange(side){
  const v=document.getElementById(side+'Fluid').value;
  document.getElementById(side+'Manual').style.display=(v==='custom')?'grid':'none';
  if(v&&v!=='custom'){
    const foul=side==='proc'?'foulProc':'foulUtil';
    if(FOULING_DEF[v])document.getElementById(foul).value=FOULING_DEF[v];
    if(side==='util'&&UTIL_APPROACH[v]!==undefined){
      document.getElementById('utilApproach').value=UTIL_APPROACH[v];
    }
    // auto-set state for steam
    if(v.startsWith('steam_')){
      document.getElementById(side+'State').value='condensation';
      onStateChange(side);
    }
  }
  showFluidProps(side);
}

function onStateChange(side){
  const st=document.getElementById(side+'State').value;
  const show=(st==='condensation'||st==='evaporation');
  document.getElementById(side+'Phase').classList.toggle('show',show);
}

function showFluidProps(side){
  const f=getFluidProps(side);
  const el=document.getElementById(side+'Props');
  if(!f||!f.name){el.innerHTML='';return;}
  el.innerHTML=`<table>
    <tr><td>Masse volumique œÅ</td><td>${f.rho} kg/m¬≥</td></tr>
    <tr><td>Viscosit√© Œº</td><td>${f.mu} mPa¬∑s</td></tr>
    <tr><td>Capacit√© calorifique Cp</td><td>${f.cp} kJ/(kg¬∑K)</td></tr>
    <tr><td>Conductivit√© Œª</td><td>${f.lam} W/(m¬∑K)</td></tr>
    <tr><td>Prandtl Pr</td><td>${f.pr.toFixed(1)}</td></tr>
    ${f.lat>0?'<tr><td>Chaleur latente</td><td>'+f.lat+' kJ/kg</td></tr>':''}
    ${f.tsat?'<tr><td>T saturation</td><td>'+f.tsat+' ¬∞C</td></tr>':''}
  </table>`;
}

// ===================== UTILITAIRES =====================
function val(id){return parseFloat(document.getElementById(id).value)||0;}
function fmt(n,d=1){return isNaN(n)?'‚Äî':n.toFixed(d);}
function fmtE(n,d=2){return isNaN(n)?'‚Äî':n.toExponential(d);}

function getFluidProps(side){
  const fid=document.getElementById(side+'Fluid').value;
  if(fid==='custom'){
    const rho=val(side+'Rho'),mu=val(side+'Mu'),cp=val(side+'Cp'),lam=val(side+'Lambda');
    return{name:'Manuel',rho,mu,cp,lam,pr:(mu*1e-3*cp*1e3)/(lam||1),lat:val(side+'Lat'),cat:'liquid'};
  }
  if(!fid||!FLUIDS[fid])return null;
  const f={...FLUIDS[fid]};
  const latInput=val(side+'Lat');
  if(latInput>0)f.lat=latInput;
  return f;
}

// ===================== EXEMPLES =====================
function loadExample(type){
  if(type==='cooling'){
    setMode('target');
    document.getElementById('operation').value='cooling';
    document.getElementById('procFluid').value='water';onFluidChange('proc');
    document.getElementById('procFlow').value=10000;
    document.getElementById('procTin').value=90;
    document.getElementById('procTout').value=40;
    document.getElementById('procP').value=3;
    document.getElementById('procState').value='liquid';onStateChange('proc');
    document.getElementById('utilFluid').value='cw';onFluidChange('util');
    document.getElementById('utilTin').value=25;
    document.getElementById('utilP').value=3;
    document.getElementById('utilState').value='liquid';onStateChange('util');
    document.getElementById('utilApproach').value=15;
  } else {
    setMode('target');
    document.getElementById('operation').value='heating';
    document.getElementById('procFluid').value='water';onFluidChange('proc');
    document.getElementById('procFlow').value=5000;
    document.getElementById('procTin').value=20;
    document.getElementById('procTout').value=80;
    document.getElementById('procP').value=3;
    document.getElementById('procState').value='liquid';onStateChange('proc');
    document.getElementById('utilFluid').value='steam_lp';onFluidChange('util');
    document.getElementById('utilTin').value=133.5;
    document.getElementById('utilP').value=3;
    document.getElementById('utilState').value='condensation';onStateChange('util');
    document.getElementById('utilApproach').value=0;
  }
}

function resetForm(){
  ['procFluid','utilFluid'].forEach(id=>document.getElementById(id).value='');
  ['procFlow','procTin','procTout','imposedQ','utilTin'].forEach(id=>document.getElementById(id).value='');
  ['procManual','utilManual'].forEach(id=>document.getElementById(id).style.display='none');
  ['procPhase','utilPhase'].forEach(id=>document.getElementById(id).classList.remove('show'));
  ['procProps','utilProps'].forEach(id=>document.getElementById(id).innerHTML='');
  setMode('target');
}

// ===================== MOTEUR DE CALCUL =====================
function calculate(){
  const ld=document.getElementById('ld');
  ld.classList.add('show');
  document.getElementById('ldT').textContent='Calculs en cours...';
  setTimeout(()=>{
    try{doCalculation();ld.classList.remove('show');sp('resultats');}
    catch(e){ld.classList.remove('show');alert('Erreur : '+e.message);console.error(e);}
  },100);
}

function doCalculation(){
  const pf=getFluidProps('proc');
  const uf=getFluidProps('util');
  if(!pf)throw new Error('S√©lectionnez le fluide process.');
  if(!uf)throw new Error('S√©lectionnez le fluide utilit√©.');

  const op=document.getElementById('operation').value; // 'cooling' ou 'heating'
  const procFlow=val('procFlow'); // kg/h
  const procTin=val('procTin');
  const procState=document.getElementById('procState').value;
  const utilTin=val('utilTin');
  const utilState=document.getElementById('utilState').value;
  const approach=val('utilApproach');
  const config=document.getElementById('flowConfig').value;
  const overdesign=val('overdesign')/100;
  const foulProc=val('foulProc');
  const foulUtil=val('foulUtil');
  const matTube=document.getElementById('matTube').value;
  const matShell=document.getElementById('matShell').value;

  if(procFlow<=0)throw new Error('Le d√©bit process doit √™tre > 0.');

  // === PUISSANCE THERMIQUE ===
  let Q, procTout;
  if(calcMode==='target'){
    procTout=val('procTout');
    if(op==='cooling'&&procTout>=procTin)throw new Error('Refroidissement : T cible doit √™tre < T entr√©e process.');
    if(op==='heating'&&procTout<=procTin)throw new Error('Chauffage : T cible doit √™tre > T entr√©e process.');

    if(procState==='condensation'){
      const xIn=val('procXin'),xOut=val('procXout');
      Q=procFlow/3600*(pf.lat*(xIn-xOut)+pf.cp*Math.abs(procTin-procTout));
    } else if(procState==='evaporation'){
      const xIn=val('procXin'),xOut=val('procXout');
      Q=procFlow/3600*(pf.lat*(xOut-xIn)+pf.cp*Math.abs(procTout-procTin));
    } else {
      Q=procFlow/3600*pf.cp*Math.abs(procTin-procTout);
    }
  } else {
    Q=val('imposedQ');
    if(Q<=0)throw new Error('La puissance Q doit √™tre > 0.');
    // Calculer T sortie process
    if(procState==='condensation'||procState==='evaporation'){
      procTout=procTin; // simplifi√© pour changement de phase
    } else {
      const dT=Q/(procFlow/3600*pf.cp);
      procTout=(op==='cooling')?(procTin-dT):(procTin+dT);
    }
  }

  // === CALCUL C√îT√â UTILIT√â ===
  let utilTout, utilFlow;
  if(utilState==='condensation'){
    // Vapeur qui condense : T sortie ‚âà T sat (condensat), d√©bit = Q / latente
    utilTout=utilTin; // condensation isotherme
    utilFlow=Q/uf.lat*3600; // kg/h
  } else if(utilState==='evaporation'){
    utilTout=utilTin;
    utilFlow=Q/uf.lat*3600;
  } else {
    // Liquide ou gaz : ŒîT = approach
    const maxDT=approach||15;
    if(op==='cooling'){
      utilTout=Math.min(utilTin+maxDT, procTin-5); // ne pas d√©passer T process
    } else {
      utilTout=Math.max(utilTin-maxDT, procTin+5);
    }
    utilFlow=Q/(uf.cp*Math.abs(utilTout-utilTin))*3600; // kg/h
  }

  // === ASSIGNATION HOT/COLD ===
  let hf,cf,hFlow,cFlow,hTin,hTout,cTin,cTout,hState,cState,foulH,foulC;
  if(op==='cooling'){
    // Process = chaud (calandre), Utilit√© = froid (tubes)
    hf=pf;cf=uf;hFlow=procFlow;cFlow=utilFlow;
    hTin=procTin;hTout=procTout;cTin=utilTin;cTout=utilTout;
    hState=procState;cState=utilState;foulH=foulProc;foulC=foulUtil;
  } else {
    // Utilit√© = chaud (calandre), Process = froid (tubes)
    hf=uf;cf=pf;hFlow=utilFlow;cFlow=procFlow;
    hTin=utilTin;hTout=utilTout;cTin=procTin;cTout=procTout;
    hState=utilState;cState=procState;foulH=foulUtil;foulC=foulProc;
  }

  // === DTLM ===
  let dT1,dT2;
  if(config==='parallel'){
    dT1=hTin-cTin;dT2=hTout-cTout;
  } else {
    dT1=hTin-cTout;dT2=hTout-cTin;
  }
  if(dT1<=0||dT2<=0)throw new Error('Croisement de temp√©rature. V√©rifiez les temp√©ratures et l\'approche utilit√©.');
  let LMTD;
  if(Math.abs(dT1-dT2)<0.01){LMTD=dT1;}
  else{LMTD=(dT1-dT2)/Math.log(dT1/dT2);}

  // === FACTEUR F ===
  let F=1.0;
  if(config==='shell12'||config==='shell24'){
    const P_r=(cTout-cTin)/(hTin-cTin);
    const R_r=(hTin-hTout)/(cTout-cTin||0.01);
    F=(config==='shell12')?calcF12(P_r,R_r):calcF24(P_r,R_r);
  } else if(config==='crossflow'){F=0.9;}
  const LMTD_c=LMTD*F;

  // === COEFFICIENT U ===
  const hCat=(hState==='condensation')?'condensation':(hState==='gas'?'gas':'liquid');
  const cCat=(cState==='evaporation')?'evaporation':(cState==='gas'?'gas':'liquid');
  let uKey=hCat+'-'+cCat;
  if(!U_TABLE[uKey])uKey=cCat+'-'+hCat;
  if(!U_TABLE[uKey])uKey='liquid-liquid';
  const Uref=U_TABLE[uKey];

  // G√©om√©trie tubes
  const tubeOD=0.01905,tubeID=0.01575,tubeWall=(tubeOD-tubeID)/2;
  const tubePitch=tubeOD*1.25,Ltube=4.88;
  const nPasses=(config==='shell12')?2:(config==='shell24'?4:2);
  const Atube=Math.PI*tubeID*tubeID/4;

  // hi (c√¥t√© tubes = froid)
  let hi;
  const Re_t=cf.rho*1.5*tubeID/(cf.mu*1e-3);
  if(cState==='evaporation'){hi=2000;}
  else if(Re_t>10000){hi=0.023*Math.pow(Re_t,0.8)*Math.pow(cf.pr,0.4)*cf.lam/tubeID;}
  else if(Re_t>2300){hi=0.116*(Math.pow(Re_t,2/3)-125)*Math.pow(cf.pr,1/3)*cf.lam/tubeID;}
  else{hi=3.66*cf.lam/tubeID;}

  // ho (c√¥t√© calandre = chaud)
  let ho;
  if(hState==='condensation'){
    ho=0.725*Math.pow(hf.rho*(hf.rho-1)*9.81*hf.lat*1000*Math.pow(hf.lam,3)/(hf.mu*1e-3*tubeOD*Math.max(Math.abs(hTin-hTout),1)),0.25);
    ho=Math.min(ho,12000);
  } else {
    const De=4*(tubePitch*tubePitch*Math.sqrt(3)/4-Math.PI*tubeOD*tubeOD/8)/(Math.PI*tubeOD/2);
    const Re_s=hf.rho*0.8*De/(hf.mu*1e-3);
    if(Re_s>2000){ho=0.36*Math.pow(Re_s,0.55)*Math.pow(hf.pr,1/3)*hf.lam/De;}
    else{ho=0.8*hf.lam/De*Math.pow(Re_s*hf.pr*De/Ltube,1/3);}
  }
  hi=Math.max(hi,50);ho=Math.max(ho,20);

  const kWall=MAT_COND[matTube]||50;
  const Uo=1/(1/ho+foulH+tubeWall/kWall+foulC+tubeOD/(tubeID*hi));
  const Uo_final=Math.min(Uo,Uref.high);

  // === SURFACE ===
  const A_net=(Q*1000)/(Uo_final*LMTD_c);
  const A_design=A_net*(1+overdesign);

  // === G√âOM√âTRIE ===
  const nTubes=Math.ceil(A_design/(Math.PI*tubeOD*Ltube));
  const nTubesPerPass=Math.ceil(nTubes/nPasses);
  const Ds=tubeOD*Math.sqrt(nTubes/(0.93*0.785))/0.85*tubePitch/tubeOD;
  const Ds_r=Math.ceil(Ds*1000/50)*50/1000;

  // Vitesses
  const vTube=(cFlow/3600)/(cf.rho*nTubesPerPass*Atube);
  const shellArea=Ds_r*(tubePitch-tubeOD)*0.4;
  const vShell=(hFlow/3600)/(hf.rho*Math.max(shellArea,0.001));

  // ŒîP
  const fT=0.046*Math.pow(Math.max(Re_t,1000),-0.2);
  const dP_tube=(4*fT*Ltube/tubeID+4)*nPasses*cf.rho*vTube*vTube/2/1000;
  const dP_shell=hf.rho*vShell*vShell/2*(Ltube/(0.4*Ds_r)+2)*0.5/1000;

  // Œµ-NTU
  const Ch=hFlow/3600*hf.cp*1000;
  const Cc=cFlow/3600*cf.cp*1000;
  const Cmin=Math.min(Ch,Cc),Cmax=Math.max(Ch,Cc);
  const Cr=(hState==='condensation'||cState==='evaporation')?0:Cmin/Cmax;
  const NTU=Uo_final*A_design/Cmin;
  let epsilon;
  if(Cr<0.01){epsilon=1-Math.exp(-NTU);}
  else if(config==='parallel'){epsilon=(1-Math.exp(-NTU*(1+Cr)))/(1+Cr);}
  else{epsilon=(1-Math.exp(-NTU*(1-Cr)))/(1-Cr*Math.exp(-NTU*(1-Cr)));}
  epsilon=Math.min(epsilon,1);

  // === S√âLECTION TYPE ===
  const Pmax=Math.max(val('procP'),val('utilP'));
  const Tmax=Math.max(hTin,cTout);
  const hasPhase=(hState==='condensation'||hState==='evaporation'||cState==='condensation'||cState==='evaporation');
  const isViscous=(hf.mu>10||cf.mu>10);
  let hxType,hxTag,hxReason=[],hxAlt=[];
  if(Pmax>30||Tmax>300||hasPhase){
    hxType='Tubes & Calandre (Shell & Tube)';hxTag='st';
    if(Pmax>30)hxReason.push('Pression √©lev√©e (>30 bar)');
    if(Tmax>300)hxReason.push('Temp√©rature √©lev√©e (>300¬∞C)');
    if(hasPhase)hxReason.push('Changement de phase');
    hxAlt=['Plate & Shell (Vahterus) si P < 100 bar'];
  } else if(isViscous){
    hxType='√âchangeur spirale';hxTag='sp';
    hxReason=['Fluide visqueux (Œº > 10 mPa¬∑s)'];hxAlt=['Tubes & calandre','√âchangeur racl√© (HRS)'];
  } else if(Pmax<=25&&Tmax<=150){
    hxType='√âchangeur √† plaques (PHE)';hxTag='phe';
    hxReason=['Compact et efficace','P < 25 bar, T < 150¬∞C'];hxAlt=['Plaques bras√©es (SWEP)','Tubes & calandre'];
  } else {
    hxType='Tubes & Calandre (Shell & Tube)';hxTag='st';
    hxReason=['Configuration standard polyvalente'];hxAlt=['√âchangeur √† plaques si conditions mod√©r√©es'];
  }

  let temaType;
  if(hasPhase&&hState==='condensation')temaType='AES';
  else if(hasPhase&&cState==='evaporation')temaType='AKT';
  else if(Tmax>200)temaType='BEM';
  else temaType='AES';

  // STOCKER
  R={Q,procTout,utilTout,utilFlow,
    hf,cf,hFlow,cFlow,hTin,hTout,cTin,cTout,hState,cState,
    LMTD,F,LMTD_c,Uo:Uo_final,Uref,A_net,A_design,
    hi,ho,kWall,foulH,foulC,
    nTubes,nPasses,nTubesPerPass,tubeOD:tubeOD*1000,tubeID:tubeID*1000,Ltube,
    Ds:Ds_r*1000,tubePitch:tubePitch*1000,
    vTube,vShell,Re_tube:Re_t,dP_tube,dP_shell,
    NTU,Cr,epsilon,Cmin,Cmax,
    hxType,hxTag,hxReason,hxAlt,temaType,
    Pmax,Tmax,matTube,matShell,overdesign,
    hasPhase,isViscous,config,
    pf,uf,op:op,procFlow:procFlow,procTin:val('procTin'),
    utilTin:utilTin,procState,utilState
  };

  renderResults();renderGeometry();renderCurves();renderSuppliers();renderSpec();renderReport();
}

function calcF12(P,R){
  if(P<=0||P>=1||R<=0)return 1;
  if(Math.abs(R-1)<0.01)return Math.max(0.5,Math.min(1,(Math.sqrt(2)*P/((1-P)*Math.log((2-P*(2-Math.sqrt(2)))/(2-P*(2+Math.sqrt(2))))))||1));
  const S=Math.sqrt(R*R+1);
  const W=(1-P*R)/(1-P);
  if(W<=0)return 0.75;
  const A=(2/P-1-R+S)/(2/P-1-R-S);
  if(A<=0)return 0.75;
  return Math.max(0.5,Math.min(1,S*Math.log(W)/(R-1)/Math.log(A)));
}
function calcF24(P,R){
  const P1=(1-Math.pow(Math.max((1-P*R)/(1-P),0.001),0.5))/(R-Math.pow(Math.max((1-P*R)/(1-P),0.001),0.5));
  return calcF12(Math.max(0.01,Math.min(0.99,P1)),R);
}

// ===================== RENDU R√âSULTATS =====================
function renderResults(){
  document.getElementById('noResults').style.display='none';
  document.getElementById('resultsContent').style.display='block';

  document.getElementById('rgThermal').innerHTML=`
    <div class="ri"><div class="rv">${fmt(R.Q,1)}</div><div class="rl">Puissance thermique</div><div class="ru">kW</div></div>
    <div class="ri"><div class="rv">${fmt(R.LMTD,1)}</div><div class="rl">DTLM</div><div class="ru">¬∞C</div></div>
    <div class="ri"><div class="rv">${fmt(R.F,3)}</div><div class="rl">Facteur F</div><div class="ru">‚Äî</div></div>
    <div class="ri"><div class="rv">${fmt(R.LMTD_c,1)}</div><div class="rl">DTLM corrig√©</div><div class="ru">¬∞C</div></div>
    <div class="ri"><div class="rv">${fmt(R.Uo,0)}</div><div class="rl">U global</div><div class="ru">W/(m¬≤¬∑K)</div></div>
    <div class="ri"><div class="rv">${fmt(R.A_net,1)}</div><div class="rl">Surface nette</div><div class="ru">m¬≤</div></div>
    <div class="ri"><div class="rv">${fmt(R.A_design,1)}</div><div class="rl">Surface design (+${(R.overdesign*100).toFixed(0)}%)</div><div class="ru">m¬≤</div></div>
    <div class="ri"><div class="rv">${fmt(R.epsilon*100,1)}</div><div class="rl">Efficacit√© Œµ</div><div class="ru">%</div></div>`;

  // Utilit√© calcul√©e
  document.getElementById('rgUtility').innerHTML=`
    <div class="ri"><div class="rv">${fmt(R.utilFlow,0)}</div><div class="rl">D√©bit utilit√© calcul√©</div><div class="ru">kg/h</div></div>
    <div class="ri"><div class="rv">${fmt(R.utilFlow/((R.uf||R.cf).rho||1000)*1000/1000,1)}</div><div class="rl">D√©bit utilit√©</div><div class="ru">m¬≥/h</div></div>
    <div class="ri"><div class="rv">${fmt(R.utilTout,1)}</div><div class="rl">T sortie utilit√©</div><div class="ru">¬∞C</div></div>
    <div class="ri"><div class="rv">${fmt(R.procTout,1)}</div><div class="rl">T sortie process</div><div class="ru">¬∞C</div></div>`;

  // Type recommand√©
  document.getElementById('hxTypeRecommendation').innerHTML=`
    <div style="display:flex;align-items:center;gap:1rem;margin-bottom:1rem">
      <span style="font-size:2rem">${R.hxTag==='st'?'üî©':R.hxTag==='phe'?'üì¶':R.hxTag==='sp'?'üåÄ':'üí®'}</span>
      <div><div style="font-size:1.3rem;font-weight:700;color:var(--acc)">${R.hxType}</div>
      ${R.temaType?'<span class="tag tag-st">TEMA '+R.temaType+'</span>':''}</div>
    </div>
    <div class="okb"><strong>Justification :</strong><ul>${R.hxReason.map(r=>'<li>'+r+'</li>').join('')}</ul></div>
    <div class="ib"><strong>Alternatives :</strong><ul>${R.hxAlt.map(a=>'<li>'+a+'</li>').join('')}</ul></div>`;

  document.getElementById('rgSizing').innerHTML=`
    <div class="ri"><div class="rv">${R.nTubes}</div><div class="rl">Nombre de tubes</div></div>
    <div class="ri"><div class="rv">${R.nPasses}</div><div class="rl">Passes tubes</div></div>
    <div class="ri"><div class="rv">${fmt(R.tubeOD,1)}√ó${fmt(R.tubeID,1)}</div><div class="rl">Tubes OD √ó ID</div><div class="ru">mm</div></div>
    <div class="ri"><div class="rv">${fmt(R.Ltube,2)}</div><div class="rl">Longueur tubes</div><div class="ru">m</div></div>
    <div class="ri"><div class="rv">${fmt(R.Ds,0)}</div><div class="rl">√ò Calandre</div><div class="ru">mm</div></div>
    <div class="ri"><div class="rv">${fmt(R.tubePitch,1)}</div><div class="rl">Pitch tubes</div><div class="ru">mm</div></div>`;

  const dp1OK=R.dP_tube<=val('dPproc'),dp2OK=R.dP_shell<=val('dPutil');
  document.getElementById('rgHydraulic').innerHTML=`
    <div class="ri"><div class="rv">${fmt(R.vTube,2)}</div><div class="rl">Vitesse tubes</div><div class="ru">m/s</div></div>
    <div class="ri"><div class="rv">${fmt(R.vShell,2)}</div><div class="rl">Vitesse calandre</div><div class="ru">m/s</div></div>
    <div class="ri"><div class="rv">${fmt(R.Re_tube,0)}</div><div class="rl">Re tubes</div><div class="ru">${R.Re_tube>10000?'Turbulent':R.Re_tube>2300?'Transition':'Laminaire'}</div></div>
    <div class="ri"><div class="rv" style="color:${dp1OK?'var(--ok)':'var(--err)'}">${fmt(R.dP_tube,1)}</div><div class="rl">ŒîP tubes</div><div class="ru">kPa</div></div>
    <div class="ri"><div class="rv" style="color:${dp2OK?'var(--ok)':'var(--err)'}">${fmt(R.dP_shell,1)}</div><div class="rl">ŒîP calandre</div><div class="ru">kPa</div></div>`;
  let alerts='';
  if(!dp1OK)alerts+='<div class="eb">‚ö†Ô∏è ŒîP tubes d√©passe la limite. Augmenter le nombre de tubes ou r√©duire les passes.</div>';
  if(!dp2OK)alerts+='<div class="eb">‚ö†Ô∏è ŒîP calandre d√©passe la limite. Augmenter le diam√®tre calandre.</div>';
  if(R.vTube>3)alerts+='<div class="wb">Vitesse tubes √©lev√©e ('+fmt(R.vTube,1)+' m/s) ‚Äî risque d\'√©rosion.</div>';
  if(R.vTube<0.5&&R.vTube>0)alerts+='<div class="wb">Vitesse tubes faible ('+fmt(R.vTube,2)+' m/s) ‚Äî risque d\'encrassement.</div>';
  document.getElementById('hydraulicAlerts').innerHTML=alerts;

  document.getElementById('rgCoeff').innerHTML=`
    <div class="ri"><div class="rv">${fmt(R.hi,0)}</div><div class="rl">hi (tubes)</div><div class="ru">W/(m¬≤¬∑K)</div></div>
    <div class="ri"><div class="rv">${fmt(R.ho,0)}</div><div class="rl">ho (calandre)</div><div class="ru">W/(m¬≤¬∑K)</div></div>
    <div class="ri"><div class="rv">${fmt(R.kWall,1)}</div><div class="rl">k paroi (${MAT_NAMES[R.matTube]})</div><div class="ru">W/(m¬∑K)</div></div>
    <div class="ri"><div class="rv">${fmtE(R.foulH)}</div><div class="rl">Fouling chaud</div><div class="ru">m¬≤¬∑K/W</div></div>
    <div class="ri"><div class="rv">${fmtE(R.foulC)}</div><div class="rl">Fouling froid</div><div class="ru">m¬≤¬∑K/W</div></div>
    <div class="ri"><div class="rv">${fmt(R.NTU,2)}</div><div class="rl">NTU</div></div>`;
}

// ===================== G√âOM√âTRIE =====================
function renderGeometry(){
  document.getElementById('noGeom').style.display='none';
  document.getElementById('geomContent').style.display='block';
  const T={AES:{f:'A ‚Äî Chapeau amovible',s:'E ‚Äî 1 passe',r:'S ‚Äî Flottante interne'},BEM:{f:'B ‚Äî Calotte',s:'E ‚Äî 1 passe',r:'M ‚Äî Plaque fixe'},AKT:{f:'A ‚Äî Chapeau amovible',s:'K ‚Äî Bouilloire',r:'T ‚Äî Flottante √† bride'}};
  const t=T[R.temaType]||T.AES;
  document.getElementById('geomParams').innerHTML=`<table class="rt">
    <tr><th colspan="2">TEMA ${R.temaType}</th></tr>
    <tr><td>Avant</td><td>${t.f}</td></tr><tr><td>Calandre</td><td>${t.s}</td></tr><tr><td>Arri√®re</td><td>${t.r}</td></tr>
    <tr><th colspan="2">Dimensions</th></tr>
    <tr><td>√ò calandre</td><td>${fmt(R.Ds,0)} mm</td></tr>
    <tr><td>Tubes</td><td>${R.nTubes} √ó √ò${fmt(R.tubeOD,1)} √ó ${fmt(R.Ltube*1000,0)} mm</td></tr>
    <tr><td>Pitch</td><td>${fmt(R.tubePitch,1)} mm ‚Äî Triangulaire 30¬∞</td></tr>
    <tr><td>Passes</td><td>${R.nPasses}</td></tr>
    <tr><td>Chicanes</td><td>Segment√©es 25% ‚Äî esp. ${fmt(R.Ds*0.4,0)} mm</td></tr>
    <tr><th colspan="2">Mat√©riaux</th></tr>
    <tr><td>Tubes</td><td>${MAT_NAMES[R.matTube]}</td></tr>
    <tr><td>Calandre</td><td>${MAT_NAMES[R.matShell]}</td></tr>
    <tr><th colspan="2">Surface</th></tr>
    <tr><td>Nette</td><td>${fmt(R.A_net,2)} m¬≤</td></tr>
    <tr><td>Design (+${(R.overdesign*100).toFixed(0)}%)</td><td>${fmt(R.A_design,2)} m¬≤</td></tr></table>`;

  // SVG
  const w=700,h=300,Ds=Math.min(200,Math.max(80,R.Ds/5)),Lt=400,x0=100,y0=(h-Ds)/2;
  let s=`<svg viewBox="0 0 ${w} ${h}" style="width:100%;max-height:300px" xmlns="http://www.w3.org/2000/svg">`;
  s+=`<defs><linearGradient id="gS" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="#3b82f6" stop-opacity="0.3"/><stop offset="100%" stop-color="#1e40af" stop-opacity="0.3"/></linearGradient></defs>`;
  s+=`<rect x="${x0}" y="${y0}" width="${Lt}" height="${Ds}" rx="10" fill="url(#gS)" stroke="#60a5fa" stroke-width="2"/>`;
  const nl=Math.min(8,R.nTubes);
  for(let i=0;i<nl;i++){const ty=y0+15+i*(Ds-30)/(nl-1);s+=`<line x1="${x0+20}" y1="${ty}" x2="${x0+Lt-20}" y2="${ty}" stroke="#f59e0b" stroke-width="1.5" opacity="0.6"/>`;}
  for(let i=1;i<=4;i++){const bx=x0+i*Lt/5;if(i%2===1)s+=`<line x1="${bx}" y1="${y0}" x2="${bx}" y2="${y0+Ds*0.75}" stroke="#94a3b8" stroke-width="2"/>`;else s+=`<line x1="${bx}" y1="${y0+Ds*0.25}" x2="${bx}" y2="${y0+Ds}" stroke="#94a3b8" stroke-width="2"/>`;}
  s+=`<rect x="${x0+60}" y="${y0-25}" width="20" height="25" fill="none" stroke="#ef4444" stroke-width="2"/>`;
  s+=`<text x="${x0+70}" y="${y0-30}" text-anchor="middle" fill="#ef4444" font-size="10">Hot in</text>`;
  s+=`<rect x="${x0+Lt-80}" y="${y0+Ds}" width="20" height="25" fill="none" stroke="#ef4444" stroke-width="2"/>`;
  s+=`<text x="${x0+Lt-70}" y="${y0+Ds+40}" text-anchor="middle" fill="#ef4444" font-size="10">Hot out</text>`;
  s+=`<path d="M${x0},${y0} Q${x0-30},${y0+Ds/2} ${x0},${y0+Ds}" fill="none" stroke="#60a5fa" stroke-width="2"/>`;
  s+=`<path d="M${x0+Lt},${y0} Q${x0+Lt+30},${y0+Ds/2} ${x0+Lt},${y0+Ds}" fill="none" stroke="#60a5fa" stroke-width="2"/>`;
  s+=`<text x="${x0+Lt+50}" y="${y0+Ds*0.3+4}" fill="#3b82f6" font-size="10">Cold in ‚Üí</text>`;
  s+=`<text x="${x0-75}" y="${y0+Ds*0.7+4}" fill="#3b82f6" font-size="10">‚Üê Cold out</text>`;
  s+=`<text x="${x0+Lt/2}" y="${h-10}" text-anchor="middle" fill="#94a3b8" font-size="11">TEMA ${R.temaType} ‚Äî √ò${fmt(R.Ds,0)}mm √ó ${fmt(R.Ltube*1000,0)}mm ‚Äî ${R.nTubes} tubes</text>`;
  s+=`</svg>`;
  document.getElementById('geomSVG').innerHTML=s;

  document.getElementById('temaRef').innerHTML=`<div class="ib">
    <strong>TEMA :</strong> 3 lettres = t√™te avant + calandre + t√™te arri√®re.<br>
    <strong>AES</strong> (standard), <strong>BEM</strong> (fixe, √©conomique), <strong>AKT</strong> (bouilloire), <strong>CFU</strong> (2 passes, U-tubes).</div>`;
}

// ===================== COURBES =====================
function renderCurves(){
  document.getElementById('noCurves').style.display='none';
  document.getElementById('curvesContent').style.display='block';
  Object.values(charts).forEach(c=>c.destroy());charts={};
  const co={responsive:true,maintainAspectRatio:false,plugins:{legend:{labels:{color:'#94a3b8'}}}};
  const ax=(xt,yt)=>({scales:{x:{title:{display:true,text:xt,color:'#94a3b8'},ticks:{color:'#64748b'}},y:{title:{display:true,text:yt,color:'#94a3b8'},ticks:{color:'#64748b'}}}});

  // Profil T
  const n=20,xD=[],hT=[],cT=[];
  for(let i=0;i<=n;i++){const f=i/n;xD.push(fmt(f*R.A_design,1));hT.push(R.hTin-f*(R.hTin-R.hTout));
    cT.push(R.config==='parallel'?R.cTin+f*(R.cTout-R.cTin):R.cTout-f*(R.cTout-R.cTin));}
  charts.temp=new Chart(document.getElementById('chartTemp'),{type:'line',data:{labels:xD,datasets:[
    {label:'C√¥t√© chaud',data:hT,borderColor:'#ef4444',backgroundColor:'rgba(239,68,68,0.1)',fill:true,tension:0.3},
    {label:'C√¥t√© froid',data:cT,borderColor:'#3b82f6',backgroundColor:'rgba(59,130,246,0.1)',fill:true,tension:0.3}
  ]},options:{...co,...ax('Surface (m¬≤)','Temp√©rature (¬∞C)')}});

  // Œµ-NTU
  const nD=[],e0=[],e5=[],e1=[];
  for(let i=0;i<=50;i++){const ntu=i*0.1;nD.push(fmt(ntu,1));
    e0.push((1-Math.exp(-ntu))*100);
    e5.push(((1-Math.exp(-ntu*0.5))/(1-0.5*Math.exp(-ntu*0.5)))*100);
    e1.push((ntu/(1+ntu))*100);}
  charts.ntu=new Chart(document.getElementById('chartNTU'),{type:'line',data:{labels:nD,datasets:[
    {label:'Cr=0',data:e0,borderColor:'#10b981',borderWidth:1.5,pointRadius:0,tension:0.3},
    {label:'Cr=0.5',data:e5,borderColor:'#f59e0b',borderWidth:1.5,pointRadius:0,tension:0.3},
    {label:'Cr=1',data:e1,borderColor:'#ef4444',borderWidth:1.5,pointRadius:0,tension:0.3},
    {label:'Fonctionnement',data:nD.map((x,i)=>Math.abs(parseFloat(x)-R.NTU)<0.1?R.epsilon*100:null),borderColor:'#fff',backgroundColor:'#f59e0b',pointRadius:8,pointStyle:'star',showLine:false}
  ]},options:{...co,...ax('NTU','Efficacit√© Œµ (%)'),scales:{...ax('NTU','Œµ (%)').scales,y:{...ax('','').scales.y,min:0,max:100}}}});

  // ŒîP vs d√©bit
  const fm=[],dpT=[],dpS=[];
  for(let i=2;i<=20;i++){const m=i/10;fm.push(fmt(m*100,0)+'%');dpT.push(R.dP_tube*m*m);dpS.push(R.dP_shell*m*m);}
  charts.dp=new Chart(document.getElementById('chartDP'),{type:'line',data:{labels:fm,datasets:[
    {label:'ŒîP tubes',data:dpT,borderColor:'#3b82f6',tension:0.3,pointRadius:2},
    {label:'ŒîP calandre',data:dpS,borderColor:'#ef4444',tension:0.3,pointRadius:2}
  ]},options:{...co,...ax('D√©bit (% nominal)','ŒîP (kPa)')}});

  // U vs d√©bit
  const uD=[];for(let i=2;i<=20;i++)uD.push(R.Uo*Math.pow(i/10,0.8));
  charts.u=new Chart(document.getElementById('chartU'),{type:'line',data:{labels:fm,datasets:[
    {label:'U (W/m¬≤¬∑K)',data:uD,borderColor:'#f59e0b',backgroundColor:'rgba(245,158,11,0.1)',fill:true,tension:0.3,pointRadius:2}
  ]},options:{...co,...ax('D√©bit (% nominal)','U (W/m¬≤¬∑K)')}});

  // Q-T
  const ql=['0',fmt(R.Q*0.25,0),fmt(R.Q*0.5,0),fmt(R.Q*0.75,0),fmt(R.Q,0)];
  const qH=[R.hTin,R.hTin-(R.hTin-R.hTout)*0.25,R.hTin-(R.hTin-R.hTout)*0.5,R.hTin-(R.hTin-R.hTout)*0.75,R.hTout];
  const qC=[R.cTin,R.cTin+(R.cTout-R.cTin)*0.25,R.cTin+(R.cTout-R.cTin)*0.5,R.cTin+(R.cTout-R.cTin)*0.75,R.cTout];
  charts.qt=new Chart(document.getElementById('chartQT'),{type:'line',data:{labels:ql,datasets:[
    {label:'Courbe chaude',data:qH,borderColor:'#ef4444',backgroundColor:'rgba(239,68,68,0.15)',fill:'+1',tension:0.1,pointRadius:4},
    {label:'Courbe froide',data:qC,borderColor:'#3b82f6',tension:0.1,pointRadius:4}
  ]},options:{...co,...ax('Q √©chang√© (kW)','T (¬∞C)')}});
}

// ===================== FOURNISSEURS =====================
function renderSuppliers(){
  const tm={'st':['st','custom','pshe'],'phe':['phe','bphe','welded','shellplate'],'sp':['spiral'],'ac':['ac','finned']};
  const rel=tm[R.hxTag]||['st','phe'];
  const filt=SUPPLIERS.filter(s=>s.types.some(t=>rel.includes(t)));
  const oth=SUPPLIERS.filter(s=>!filt.includes(s));
  document.getElementById('supplierFilter').innerHTML=`<strong>Type :</strong> ${R.hxType} ‚Äî ${filt.length} fournisseurs sp√©cialis√©s.`;
  let h='<h3 style="color:var(--acc);margin:1rem 0 .5rem">Recommand√©s</h3><div class="supplier-grid">';
  filt.forEach(s=>{h+=`<div class="supplier-card"><h4>${s.logo} ${s.name}</h4><div class="country">${s.country}</div><div class="spec">${s.spec}</div><a href="${s.url}" target="_blank">${s.url.replace('https://','')}</a></div>`;});
  h+='</div>';
  if(oth.length){h+='<h3 style="color:var(--t3);margin:1.5rem 0 .5rem">Autres fournisseurs</h3><div class="supplier-grid">';
  oth.forEach(s=>{h+=`<div class="supplier-card" style="opacity:0.6"><h4>${s.logo} ${s.name}</h4><div class="country">${s.country}</div><div class="spec">${s.spec}</div><a href="${s.url}" target="_blank">${s.url.replace('https://','')}</a></div>`;});
  h+='</div>';}
  document.getElementById('supplierGrid').innerHTML=h;
}

// ===================== FICHE SPEC =====================
function renderSpec(){
  document.getElementById('noSpec').style.display='none';
  document.getElementById('specContent').style.display='block';
  const d=new Date().toISOString().split('T')[0];
  const pName=R.op==='cooling'?R.pf.name:R.uf.name;
  const uName=R.op==='cooling'?R.uf.name:R.pf.name;
  document.getElementById('specSheet').innerHTML=`<div class="spec-sheet" id="specPrint">
    <h2>FICHE DE SP√âCIFICATION ‚Äî √âCHANGEUR DE CHALEUR</h2>
    <table>
      <tr class="section-title"><td colspan="4">1. INFORMATIONS G√âN√âRALES</td></tr>
      <tr><td>Client</td><td><input value=""></td><td>N¬∞ Doc</td><td><input value="HX-${d.replace(/-/g,'')}-001"></td></tr>
      <tr><td>Projet</td><td><input value=""></td><td>R√©v.</td><td><input value="A"></td></tr>
      <tr><td>Service</td><td><input value="${R.pf.name} / ${R.uf.name}"></td><td>Date</td><td>${d}</td></tr>
      <tr><td>Tag</td><td><input value="E-"></td><td>TEMA</td><td>${R.temaType}</td></tr>
      <tr class="section-title"><td colspan="4">2. DONN√âES PROC√âD√â</td></tr>
      <tr><th></th><th>C√¥t√© Chaud (Calandre)</th><th>C√¥t√© Froid (Tubes)</th><th>Unit√©</th></tr>
      <tr><td>Fluide</td><td>${R.hf.name}</td><td>${R.cf.name}</td><td></td></tr>
      <tr><td>D√©bit</td><td>${fmt(R.hFlow,0)}</td><td>${fmt(R.cFlow,0)}</td><td>kg/h</td></tr>
      <tr><td>T entr√©e</td><td>${fmt(R.hTin,1)}</td><td>${fmt(R.cTin,1)}</td><td>¬∞C</td></tr>
      <tr><td>T sortie</td><td>${fmt(R.hTout,1)}</td><td>${fmt(R.cTout,1)}</td><td>¬∞C</td></tr>
      <tr><td>Pression</td><td>${fmt(val('procP'),1)}</td><td>${fmt(val('utilP'),1)}</td><td>bar</td></tr>
      <tr><td>œÅ</td><td>${fmt(R.hf.rho,0)}</td><td>${fmt(R.cf.rho,0)}</td><td>kg/m¬≥</td></tr>
      <tr><td>Œº</td><td>${fmt(R.hf.mu,2)}</td><td>${fmt(R.cf.mu,2)}</td><td>mPa¬∑s</td></tr>
      <tr><td>Cp</td><td>${fmt(R.hf.cp,2)}</td><td>${fmt(R.cf.cp,2)}</td><td>kJ/(kg¬∑K)</td></tr>
      <tr><td>Œª</td><td>${fmt(R.hf.lam,3)}</td><td>${fmt(R.cf.lam,3)}</td><td>W/(m¬∑K)</td></tr>
      <tr><td>Fouling</td><td>${fmtE(R.foulH)}</td><td>${fmtE(R.foulC)}</td><td>m¬≤¬∑K/W</td></tr>
      <tr><td>ŒîP calc.</td><td>${fmt(R.dP_shell,1)}</td><td>${fmt(R.dP_tube,1)}</td><td>kPa</td></tr>
      <tr class="section-title"><td colspan="4">3. PERFORMANCES</td></tr>
      <tr><td>Q</td><td colspan="2">${fmt(R.Q,1)}</td><td>kW</td></tr>
      <tr><td>DTLM corr.</td><td colspan="2">${fmt(R.LMTD_c,1)}</td><td>¬∞C</td></tr>
      <tr><td>U</td><td colspan="2">${fmt(R.Uo,0)}</td><td>W/(m¬≤¬∑K)</td></tr>
      <tr><td>Surface design</td><td colspan="2">${fmt(R.A_design,2)}</td><td>m¬≤</td></tr>
      <tr class="section-title"><td colspan="4">4. CONSTRUCTION</td></tr>
      <tr><td>Type</td><td colspan="3">${R.hxType} ‚Äî TEMA ${R.temaType}</td></tr>
      <tr><td>√ò calandre</td><td colspan="2">${fmt(R.Ds,0)}</td><td>mm</td></tr>
      <tr><td>Tubes</td><td colspan="2">${R.nTubes} √ó √ò${fmt(R.tubeOD,1)} √ó ${fmt(R.Ltube*1000,0)} mm</td></tr>
      <tr><td>Passes</td><td colspan="2">${R.nPasses}</td><td></td></tr>
      <tr><td>Mat. tubes</td><td colspan="3">${MAT_NAMES[R.matTube]}</td></tr>
      <tr><td>Mat. calandre</td><td colspan="3">${MAT_NAMES[R.matShell]}</td></tr>
      <tr class="section-title"><td colspan="4">5. CONDITIONS DE DESIGN</td></tr>
      <tr><td>P design</td><td><input value="${fmt(Math.ceil(R.Pmax*1.1/0.5)*0.5,1)}"> bar g</td><td><input value="${fmt(Math.ceil(R.Pmax*1.1/0.5)*0.5,1)}"> bar g</td><td></td></tr>
      <tr><td>T design</td><td><input value="${fmt(Math.ceil((R.Tmax+20)/10)*10,0)}"> ¬∞C</td><td><input value="${fmt(Math.ceil((R.Tmax+20)/10)*10,0)}"> ¬∞C</td><td></td></tr>
      <tr class="section-title"><td colspan="4">6. CODES & NORMES</td></tr>
      <tr><td>Code</td><td colspan="3"><input value="ASME VIII Div.1 / EN 13445"></td></tr>
      <tr><td>Standard HX</td><td colspan="3"><input value="TEMA R / API 660"></td></tr>
      <tr><td>PED</td><td colspan="3"><input value="2014/68/EU ‚Äî Cat. III"></td></tr>
      <tr class="section-title"><td colspan="4">7. NOTES</td></tr>
      <tr><td colspan="4"><textarea style="width:100%;min-height:60px;border:1px solid #ccc;padding:.5rem;font-family:DM Sans;font-size:.8rem" placeholder="Notes..."></textarea></td></tr>
    </table>
    <div style="text-align:center;margin-top:1rem;font-size:.75rem;color:#999">HeatXAI ‚Äî ${d}</div></div>`;
}
function printSpec(){document.querySelectorAll('.panel').forEach(p=>p.classList.remove('print-target'));document.getElementById('p-datasheet').classList.add('print-target');window.print();}

// ===================== RAPPORT =====================
function renderReport(){
  document.getElementById('noReport').style.display='none';
  document.getElementById('reportContent').style.display='block';
  const d=new Date().toISOString().split('T')[0];
  const opLabel=R.op==='cooling'?'refroidissement':'chauffage';
  document.getElementById('reportSheet').innerHTML=`<div class="spec-sheet" id="reportPrint">
    <h2>RAPPORT TECHNIQUE ‚Äî DIMENSIONNEMENT √âCHANGEUR</h2>
    <p style="text-align:center;color:#666;margin-bottom:1.5rem">HeatXAI ‚Äî ${d}</p>
    <h3 style="color:#d97706;border-bottom:2px solid #f59e0b;padding-bottom:.3rem">1. Objet</h3>
    <p>${opLabel.charAt(0).toUpperCase()+opLabel.slice(1)} de <strong>${R.pf.name}</strong> (${fmt(R.procFlow,0)} kg/h)
    de ${fmt(R.procTin,0)}¬∞C √† <strong>${fmt(R.procTout,1)}¬∞C</strong> en utilisant <strong>${R.uf.name}</strong> comme utilit√©.
    Puissance : <strong>${fmt(R.Q,1)} kW</strong>.</p>
    <h3 style="color:#d97706;border-bottom:2px solid #f59e0b;padding-bottom:.3rem;margin-top:1.5rem">2. Hypoth√®ses</h3>
    <ul><li>R√©gime permanent, propri√©t√©s √† temp√©rature moyenne</li>
    <li>Configuration : ${R.config}</li><li>F = ${fmt(R.F,3)}</li>
    <li>Corr√©lation tubes : ${R.Re_tube>10000?'Dittus-Boelter':'Sieder-Tate'}</li>
    <li>Corr√©lation calandre : ${R.hState==='condensation'?'Nusselt condensation':'Kern'}</li>
    <li>Fouling TEMA : ${fmtE(R.foulH)} / ${fmtE(R.foulC)} m¬≤¬∑K/W</li>
    <li>Surdesign : +${(R.overdesign*100).toFixed(0)}%</li></ul>
    <h3 style="color:#d97706;border-bottom:2px solid #f59e0b;padding-bottom:.3rem;margin-top:1.5rem">3. R√©sultats</h3>
    <table><tr><th>Param√®tre</th><th>Valeur</th><th>Unit√©</th></tr>
    <tr><td>Q</td><td>${fmt(R.Q,1)}</td><td>kW</td></tr>
    <tr><td>DTLM corr.</td><td>${fmt(R.LMTD_c,1)}</td><td>¬∞C</td></tr>
    <tr><td>U</td><td>${fmt(R.Uo,0)}</td><td>W/(m¬≤¬∑K)</td></tr>
    <tr><td>Surface design</td><td>${fmt(R.A_design,1)}</td><td>m¬≤</td></tr>
    <tr><td>Œµ</td><td>${fmt(R.epsilon*100,1)}</td><td>%</td></tr>
    <tr><td>D√©bit utilit√© calcul√©</td><td>${fmt(R.utilFlow,0)}</td><td>kg/h</td></tr>
    <tr><td>T sortie utilit√©</td><td>${fmt(R.utilTout,1)}</td><td>¬∞C</td></tr></table>
    <h3 style="color:#d97706;border-bottom:2px solid #f59e0b;padding-bottom:.3rem;margin-top:1.5rem">4. √âquipement</h3>
    <p><strong>${R.hxType}</strong> ‚Äî TEMA ${R.temaType}</p>
    <table><tr><td>Calandre</td><td>√ò${fmt(R.Ds,0)} mm</td></tr>
    <tr><td>Tubes</td><td>${R.nTubes} √ó √ò${fmt(R.tubeOD,1)} √ó ${fmt(R.Ltube*1000,0)} mm</td></tr>
    <tr><td>Passes</td><td>${R.nPasses}</td></tr>
    <tr><td>Mat√©riaux</td><td>${MAT_NAMES[R.matTube]} / ${MAT_NAMES[R.matShell]}</td></tr></table>
    <h3 style="color:#d97706;border-bottom:2px solid #f59e0b;padding-bottom:.3rem;margin-top:1.5rem">5. V√©rifications</h3>
    <table><tr><th>Param√®tre</th><th>Valeur</th><th>Limite</th><th>Statut</th></tr>
    <tr><td>ŒîP tubes</td><td>${fmt(R.dP_tube,1)} kPa</td><td>${val('dPproc')} kPa</td><td>${R.dP_tube<=val('dPproc')?'OK':'NOK'}</td></tr>
    <tr><td>ŒîP calandre</td><td>${fmt(R.dP_shell,1)} kPa</td><td>${val('dPutil')} kPa</td><td>${R.dP_shell<=val('dPutil')?'OK':'NOK'}</td></tr>
    <tr><td>V tubes</td><td>${fmt(R.vTube,2)} m/s</td><td>0.5‚Äì3 m/s</td><td>${R.vTube>=0.5&&R.vTube<=3?'OK':'Hors plage'}</td></tr>
    <tr><td>V calandre</td><td>${fmt(R.vShell,2)} m/s</td><td>0.3‚Äì1.5 m/s</td><td>${R.vShell>=0.3&&R.vShell<=1.5?'OK':'Hors plage'}</td></tr></table>
    <h3 style="color:#d97706;border-bottom:2px solid #f59e0b;padding-bottom:.3rem;margin-top:1.5rem">6. Recommandations</h3>
    <ul><li>Confirmer par simulation d√©taill√©e (HTRI/Aspen EDR) avant fabrication.</li>
    <li>Consulter les fournisseurs identifi√©s (onglet Fournisseurs) pour chiffrage.</li>
    <li>V√©rifier compatibilit√© mat√©riaux / corrosion.</li></ul>
    <div style="text-align:center;margin-top:2rem;border-top:1px solid #ccc;padding-top:1rem;font-size:.75rem;color:#999">HeatXAI ‚Äî ${d}</div></div>`;
}
function printReport(){document.querySelectorAll('.panel').forEach(p=>p.classList.remove('print-target'));document.getElementById('p-rapport').classList.add('print-target');window.print();}

// ===================== INIT =====================
initFluids();
</script>
</body>
</html>
